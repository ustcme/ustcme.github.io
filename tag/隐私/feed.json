{
    "version": "https://jsonfeed.org/version/1",
    "title": "Sakura • All posts by \"隐私\" tag",
    "description": "一个专注于技术和思考分享的博客",
    "home_page_url": "https://sakurame.eu.org",
    "items": [
        {
            "id": "https://sakurame.eu.org/2024/03/14/privacy/Canokey%E4%B8%8D%E5%AE%8C%E5%85%A8%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97-%E6%8C%81%E7%BB%AD%E8%B8%A9%E5%9D%91%E4%B8%AD/",
            "url": "https://sakurame.eu.org/2024/03/14/privacy/Canokey%E4%B8%8D%E5%AE%8C%E5%85%A8%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97-%E6%8C%81%E7%BB%AD%E8%B8%A9%E5%9D%91%E4%B8%AD/",
            "title": "Canokey不完全食用指南--持续踩坑中",
            "date_published": "2024-03-13T16:19:19.000Z",
            "content_html": "<p>居然在 2024 年收到了 Canokey Pigeon，这很不鸽子。折腾了几个小时，把几个主要的用法都试了一遍，包括 OTP， FIDO2，OpenPGP Smartcard 和 PIV。除了 Windows 下 PIV 无法使用  <code>NIST P-256/P-384</code>  算法，以及某些 OpenPGP 最新的特性还未支持，整体算是物美价廉。</p>\n<p>本指南<strong>基于 Windows 10 Powershell</strong>，其它操作系统基本也可参考使用。虽然本文基于 Canokey Pigeon，但大部分内容均可适用于其他硬件密钥，包括但不限于 Yubikey，Feitian key 等。同时本文的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9lZGl0c3QuY29tLzIwMjIvY2Fub2tleS1ndWlkZS8jT3BlblBHUA==\">OpenPGP 部分</span>也可单独作为比较完善的 PGP 使用指南来参考，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lZGl0c3QuY29tLzIwMjIvY2Fub2tleS1ndWlkZS8jUElW\">PIV 部分</span>基本可以说是目前最完整的中文使用指南。</p>\n<h2 id=\"基础配置\"><a class=\"anchor\" href=\"#基础配置\">#</a> 基础配置</h2>\n<p>拿到后插入电脑会自动弹出 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb25zb2xlLmNhbm9rZXlzLm9yZw==\">Canokey Web Console</span> 提示，也可通过自行访问，注意<strong>目前只支持 Chromium 内核浏览器</strong>，点击右上角连接，如果失败请尝试重新插拔后等待一会重试。</p>\n<p>连接成功后会显示 Canokey 的信息，首先进入  <code>Settings</code>  设置全局的  <code>Admin PIN</code> （默认  <code>123456</code> ） <strong>并牢记</strong>，同时可以配置部分选项，个人建议把  <code>WebUSB prompt enabled</code>  关闭，有些烦人。</p>\n<p>注意这里的  <code>Admin PIN</code>  <strong>只用于</strong> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb25zb2xlLmNhbm9rZXlzLm9yZw==\">Canokey Web Console</span> 的  <code>Settings</code> ，与下方所有  <code>PIN</code>  均无关，请勿混淆，如觉得麻烦也可跳过这一步。</p>\n<h2 id=\"otp\"><a class=\"anchor\" href=\"#otp\">#</a> OTP</h2>\n<p>One-time Password (OTP) 是最常见的二步验证方法，主要分为 HMAC-based One-time Password algorithm (HOTP) 和 Time-based One-time Password  (TOTP)，由于绝大部分平台支持的都是后者，本文仅介绍 TOTP。当然国内平台爱用的短信验证码也算一种  OTP，但是这种方法有其缺陷，并不自主可控。</p>\n<p>如果那你使用过 Google Authenticator 之类的软件，那你一定对 TOTP 不陌生，其最常见的形式是一个有着 30 秒倒计时的六位数字，本质上是基于一个预共享的密钥和当前时间计算出的验证码。</p>\n<p>通常网站会给出一个二维码让我们扫描，其内容一般如下</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>otpauth:<span class=\"token operator\">/</span><span class=\"token operator\">/</span>totp/Example:alice@example<span class=\"token punctuation\">.</span>com?secret=JBSWY3DPEHPK3PXP&amp;issuer=Example</pre></td></tr></table></figure><p>在 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb25zb2xlLmNhbm9rZXlzLm9yZw==\">Canokey Web Console</span> 的 TOTP/HTOP 部分添加，重要的是  <code>secret</code>  参数，也就是密钥。部分网站可能会直接给出一个密钥，同样添加即可。Canokey 最多支持存储 128 个密钥，反正我是用不完。还可以通过  Yubico Authenticator 来管理和读取 OTP，可能需要到设置中指定 custom reader 为 canokey。</p>\n<h2 id=\"fido2\"><a class=\"anchor\" href=\"#fido2\">#</a> FIDO2</h2>\n<p>首先引用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9mbHloaWdoZXIudG9wL2RldmVsb3AvMjE2MC5odG1s\">谈谈 WebAuthn</span> 的一段的介绍：</p>\n<blockquote>\n<p>FIDO2 标准主要包括四个部分，其一是用于网站和访客设备交互的 WebAuthn，而 Client to Authenticator  Protocol 2（CTAP2，客户端 - 认证器协议）作为 WebAuthn  的补充，则是用于访客的设备和认证器交互的协议。标准的其他两个部分则是 U2F 和 UAF 规范。</p>\n</blockquote>\n<p>实际上这部分的使用是最简单的，只需要在支持的网站或应用中添加硬件密钥即可，目前大部分是用作 2FA，我自己常用的包括 GitHub,  Cloudflare, Microsoft, Google, Twitter, Facebook 等，更多支持 FIDO2/U2F/TOTP  的网站可以参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly8yZmEuZGlyZWN0b3J5L2ludC8=\">2FA Directory</span>。</p>\n<p>注意部分网站添加时会首先弹出含有  <code>Windows Hello</code>  的选项，需要<strong>点击取消</strong>跳过，再添加硬件密钥。首次添加时需要自定义  <code>PIN</code> ，牢记即可。</p>\n<p>目前 Microsoft 账户支持使用硬件密钥实现单因素登录，即无需密码直接登录，可以进入账户的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hY2NvdW50LmxpdmUuY29tL3Byb29mcy9tYW5hZ2UvYWRkaXRpb25hbA==\">其他安全选项</span>部分进行添加。</p>\n<h2 id=\"openpgp\"><a class=\"anchor\" href=\"#openpgp\">#</a> OpenPGP</h2>\n<p>这部分可以算是 Canokey 最主要的应用场景，关于 OpenPGP 的具体介绍就不在这里展开了，可以参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly91bHljLmdpdGh1Yi5pby8yMDIxLzAxLzEzLzIwMjElRTUlQjklQjQtJUU3JTk0JUE4JUU2JTlCJUI0JUU3JThFJUIwJUU0JUJCJUEzJUU3JTlBJTg0JUU2JTk2JUI5JUU2JUIzJTk1JUU0JUJEJUJGJUU3JTk0JUE4UEdQLSVFNCVCOCU4QS8=\">2021 年，用更现代的方法使用 PGP</span> 系列文章。下面完整记录一下配置流程。</p>\n<p>注意<strong>以下操作全部基于 Windows 10 Powershell，其它系统可能存在细微差异</strong>。为保护私钥安全，建议全程在<strong>离线、一次性环境中</strong>完成。</p>\n<h3 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h3>\n<p>Windows 用户可下载 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ncGc0d2luLm9yZy9kb3dubG9hZC5odG1s\">Gpg4Win</span>，Linux/macOS 用户使用对应包管理软件安装即可。</p>\n<h3 id=\"生成主密钥\"><a class=\"anchor\" href=\"#生成主密钥\">#</a> 生成主密钥</h3>\n<p>首先生成主密钥，注意以下全部密钥均为一次性示例，并非本人 PGP 密钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>expert <span class=\"token operator\">--</span>full-gen-key</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gpg <span class=\"token punctuation\">(</span>GnuPG<span class=\"token punctuation\">)</span> 2<span class=\"token punctuation\">.</span>3<span class=\"token punctuation\">.</span>4<span class=\"token punctuation\">;</span> Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> 2021 g10 Code GmbH</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>This is free software: you are free to change and redistribute it<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>There is NO WARRANTY<span class=\"token punctuation\">,</span> to the extent permitted by law<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Please <span class=\"token function\">select</span> what kind of key you want:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span> RSA and RSA</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token punctuation\">(</span>2<span class=\"token punctuation\">)</span> DSA and Elgamal</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token punctuation\">(</span>3<span class=\"token punctuation\">)</span> DSA <span class=\"token punctuation\">(</span>sign only<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token punctuation\">(</span>4<span class=\"token punctuation\">)</span> RSA <span class=\"token punctuation\">(</span>sign only<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token punctuation\">(</span>7<span class=\"token punctuation\">)</span> DSA <span class=\"token punctuation\">(</span><span class=\"token function\">set</span> your own capabilities<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token punctuation\">(</span>8<span class=\"token punctuation\">)</span> RSA <span class=\"token punctuation\">(</span><span class=\"token function\">set</span> your own capabilities<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token punctuation\">(</span>9<span class=\"token punctuation\">)</span> ECC <span class=\"token punctuation\">(</span>sign and encrypt<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>default*</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">(</span>10<span class=\"token punctuation\">)</span> ECC <span class=\"token punctuation\">(</span>sign only<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">(</span>11<span class=\"token punctuation\">)</span> ECC <span class=\"token punctuation\">(</span><span class=\"token function\">set</span> your own capabilities<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">(</span>13<span class=\"token punctuation\">)</span> Existing key</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">(</span>14<span class=\"token punctuation\">)</span> Existing key <span class=\"token keyword\">from</span> card</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Your selection? 11</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 推荐使用 ECC 算法</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Possible actions <span class=\"token keyword\">for</span> this ECC key: Sign Certify Authenticate</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Current allowed actions: Sign Certify</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   <span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span> Toggle the sign capability</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span> Toggle the authenticate capability</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token punctuation\">(</span>Q<span class=\"token punctuation\">)</span> Finished</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Your selection? s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 主密钥只保留 Certify 功能，其他功能使用子密钥</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>Possible actions <span class=\"token keyword\">for</span> this ECC key: Sign Certify Authenticate</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Current allowed actions: Certify</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   <span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span> Toggle the sign capability</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span> Toggle the authenticate capability</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   <span class=\"token punctuation\">(</span>Q<span class=\"token punctuation\">)</span> Finished</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Your selection? q</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Please <span class=\"token function\">select</span> which elliptic curve you want:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   <span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span> Curve 25519 <span class=\"token operator\">*</span>default*</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   <span class=\"token punctuation\">(</span>2<span class=\"token punctuation\">)</span> Curve 448</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   <span class=\"token punctuation\">(</span>3<span class=\"token punctuation\">)</span> NIST P-256</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   <span class=\"token punctuation\">(</span>4<span class=\"token punctuation\">)</span> NIST P-384</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   <span class=\"token punctuation\">(</span>5<span class=\"token punctuation\">)</span> NIST P-521</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   <span class=\"token punctuation\">(</span>6<span class=\"token punctuation\">)</span> Brainpool P-256</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   <span class=\"token punctuation\">(</span>7<span class=\"token punctuation\">)</span> Brainpool P-384</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   <span class=\"token punctuation\">(</span>8<span class=\"token punctuation\">)</span> Brainpool P-512</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   <span class=\"token punctuation\">(</span>9<span class=\"token punctuation\">)</span> secp256k1</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Your selection? 1</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Please specify how long the key should be valid<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>         0 = key does not expire</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      &lt;n>  = key expires in n days</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      &lt;n>w = key expires in n weeks</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      &lt;n>m = key expires in n months</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      &lt;n>y = key expires in n years</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>Key is valid <span class=\"token keyword\">for</span>? <span class=\"token punctuation\">(</span>0<span class=\"token punctuation\">)</span> 0</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>Key does not expire at all</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>Is this correct? <span class=\"token punctuation\">(</span>y/N<span class=\"token punctuation\">)</span> y</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token comment\"># 主密钥永不过期即可</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>Real name: Editst</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Email address: editst@example<span class=\"token punctuation\">.</span>com</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Comment:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>You selected this USER-ID:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token string\">\"Editst &lt;editst@example.com>\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\"># 这里按实际情况填写，注意保护自己的隐私</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>Change <span class=\"token punctuation\">(</span>N<span class=\"token punctuation\">)</span>ame<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span>omment<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>E<span class=\"token punctuation\">)</span>mail or <span class=\"token punctuation\">(</span>O<span class=\"token punctuation\">)</span>kay/<span class=\"token punctuation\">(</span>Q<span class=\"token punctuation\">)</span>uit? o</pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>We need to generate a lot of random bytes<span class=\"token punctuation\">.</span> It is a good idea to perform</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>some other action <span class=\"token punctuation\">(</span><span class=\"token function\">type</span> on the keyboard<span class=\"token punctuation\">,</span> <span class=\"token function\">move</span> the mouse<span class=\"token punctuation\">,</span> utilize the</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>disks<span class=\"token punctuation\">)</span> during the prime generation<span class=\"token punctuation\">;</span> this gives the random number</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>generator a better chance to gain enough entropy<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\"># Windnows 下会弹出窗口输入密码，注意一定要保管好！！！</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>gpg: revocation certificate stored as <span class=\"token string\">'C:\\\\Users\\\\XXX\\\\AppData\\\\Roaming\\\\gnupg\\\\openpgp-revocs.d\\\\68697537A54B1F0BFC05E1D9787E848E1A98D086.rev'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>public and secret key created and signed<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token comment\"># 会自动生成吊销证书，注意保存到安全的地方</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>pub   ed25519/787E848E1A98D086 2022-01-01 <span class=\"token namespace\">[C]</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      Key fingerprint = 6869 7537 A54B 1F0B FC05  E1D9 787E 848E 1A98 D086</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>uid                              Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr></table></figure><h3 id=\"生成子密钥\"><a class=\"anchor\" href=\"#生成子密钥\">#</a> 生成子密钥</h3>\n<p>查看目前的私钥，可以发现只有一个用作  <code>Certify</code>  的主密钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>fingerprint <span class=\"token operator\">--</span>keyid-format long <span class=\"token operator\">-</span>K</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>C:\\Users\\XXX\\AppData\\Roaming\\gnupg\\pubring<span class=\"token punctuation\">.</span>kbx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sec   ed25519/787E848E1A98D086 2022-01-01 <span class=\"token namespace\">[C]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      Key fingerprint = 6869 7537 A54B 1F0B FC05  E1D9 787E 848E 1A98 D086</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>uid                 <span class=\"token namespace\">[ultimate]</span> Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr></table></figure><p>下面生成不同功能的子密钥，其中  <code>&lt;fingerprint&gt;</code>  为上面输出的密钥指纹，本示例中即为  <code>68697537A54B1F0BFC05E1D9787E848E1A98D086</code> 。最后的  <code>2y</code>  为密钥过期时间，可自行设置，如不填写默认永不过期。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>quick-<span class=\"token function\">add-key</span> &lt;fingerprint> cv25519 encr 2y</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gpg <span class=\"token operator\">--</span>quick-<span class=\"token function\">add-key</span> &lt;fingerprint> ed25519 auth 2y</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gpg <span class=\"token operator\">--</span>quick-<span class=\"token function\">add-key</span> &lt;fingerprint> ed25519 sign 2y</pre></td></tr></table></figure><p>再次查看目前的私钥，可以看到已经包含了这三个子密钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>fingerprint <span class=\"token operator\">--</span>keyid-format long <span class=\"token operator\">-</span>K</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>C:\\Users\\XXX\\AppData\\Roaming\\gnupg\\pubring<span class=\"token punctuation\">.</span>kbx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sec   ed25519/787E848E1A98D086 2022-01-01 <span class=\"token namespace\">[C]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      Key fingerprint = 6869 7537 A54B 1F0B FC05  E1D9 787E 848E 1A98 D086</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>uid                 <span class=\"token namespace\">[ultimate]</span> Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ssb   ed25519/055917609C9C0D7B 2022-01-01 <span class=\"token namespace\">[S]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      Key fingerprint = E99F 3D15 7ACF 7E24 3DC8  FFE7 0559 1760 9C9C 0D7B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ssb   ed25519/05F4A6C335157258 2022-01-01 <span class=\"token namespace\">[A]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      Key fingerprint = C4B9 7EEC 4060 F856 7A4D  2956 05F4 A6C3 3515 7258</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ssb   cv25519/C5B8214C3AD21C6C 2022-01-01 <span class=\"token namespace\">[E]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      Key fingerprint = E39E E067 3233 BD73 7ED1  15F1 C5B8 214C 3AD2 1C6C</pre></td></tr></table></figure><p>上面生成了三种功能的子密钥（ssb），分别为加密（E）、认证（A）、签名（S），对应  <code>OpenPGP Applet</code>  中的三个插槽。由于  <code>ECC</code>  实现的原因，加密密钥的算法区别于其他密钥的算法。</p>\n<p>加密密钥用于加密文件和信息。签名密钥主要用于给自己的信息签名，保证这真的是来自<strong>我</strong>的信息。认证密钥主要用于 SSH 登录。</p>\n<h3 id=\"uid-设置\"><a class=\"anchor\" href=\"#uid-设置\">#</a> UID 设置</h3>\n<p>额外提醒，如果你想把这个密钥用于 Git Commit 的签名，同时提交到 GitHub，GitLab 等服务，请确保  <code>UID</code>  信息  <code>Editst &lt;editst@example.com&gt;</code>  与你的本地 Git 邮箱以及 GitHub 已验证邮箱一致。</p>\n<p>也可以单独添加 Git 使用的  <code>UID</code> 。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>quick-<span class=\"token function\">add-uid</span> &lt;fingerprint> <span class=\"token string\">'Editst &lt;editst.github@example.com>'</span></pre></td></tr></table></figure><p>gpg 会把你最近添加的  <code>UID</code>  作为主  <code>UID</code> ，你也可以手动指定。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>quick-<span class=\"token function\">set-primary</span><span class=\"token operator\">-</span>uid &lt;fingerprint> <span class=\"token string\">'Editst &lt;editst@example.com>'</span></pre></td></tr></table></figure><h3 id=\"备份\"><a class=\"anchor\" href=\"#备份\">#</a> 备份</h3>\n<p>首先导出公钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">-</span>ao public-key<span class=\"token punctuation\">.</span>pub <span class=\"token operator\">--</span>export 787E848E1A98D086</pre></td></tr></table></figure><p>然后分别导出各个私钥，请务必备份好，<strong>特别是主密钥和吊销证书</strong>，建议多介质异地备份。同时记得备份之前自动生成的吊销证书： <code>%APPDATA%\\gnupg\\openpgp-revocs.d\\68697537A54B1F0BFC05E1D9787E848E1A98D086.rev</code> 。</p>\n<p>注意  <code>key id</code>  后面的  <code>!</code> ，表示只导出这一个私钥，若没有的话默认导出全部私钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">-</span>ao sec-key<span class=\"token punctuation\">.</span>asc <span class=\"token operator\">--</span><span class=\"token function\">export-secret</span><span class=\"token operator\">-</span>key 787E848E1A98D086!</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 主密钥，请务必保存好！！！</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gpg <span class=\"token operator\">-</span>ao sign-key<span class=\"token punctuation\">.</span>asc <span class=\"token operator\">--</span><span class=\"token function\">export-secret</span><span class=\"token operator\">-</span>key 055917609C9C0D7B!</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gpg <span class=\"token operator\">-</span>ao auth-key<span class=\"token punctuation\">.</span>asc <span class=\"token operator\">--</span><span class=\"token function\">export-secret</span><span class=\"token operator\">-</span>key 05F4A6C335157258!</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gpg <span class=\"token operator\">-</span>ao encr-key<span class=\"token punctuation\">.</span>asc <span class=\"token operator\">--</span><span class=\"token function\">export-secret</span><span class=\"token operator\">-</span>key C5B8214C3AD21C6C!</pre></td></tr></table></figure><p>具体备份策略可以参照 <span class=\"exturl\" data-url=\"aHR0cHM6Ly91bHljLmdpdGh1Yi5pby8yMDIxLzAxLzE4LzIwMjElRTUlQjklQjQtJUU3JTk0JUE4JUU2JTlCJUI0JUU3JThFJUIwJUU0JUJCJUEzJUU3JTlBJTg0JUU2JTk2JUI5JUU2JUIzJTk1JUU0JUJEJUJGJUU3JTk0JUE4UEdQLSVFNCVCOCVBRC8=\">2021 年，用更现代的方法使用 PGP（中）</span></p>\n<blockquote>\n<ul>\n<li>主密钥只保留一份，建议备份在一个全盘加密的 U 盘中，然后放在一个绝对安全的地方。</li>\n<li>子密钥可以复制多份，通过 U 盘导入各个设备，专密专用，日常使用推荐用智能卡（比如 Yubikey），还能免去每次输密码的麻烦</li>\n<li>撤销凭证可以和主密钥放在一起备份一份， 另外单独备份一份（这样丢失密钥，起码还可以撤销）</li>\n</ul>\n</blockquote>\n<p>下面介绍配合智能卡使用子密钥</p>\n<h3 id=\"导入-canokey\"><a class=\"anchor\" href=\"#导入-canokey\">#</a> 导入 Canokey</h3>\n<p>首先修改  <code>OpenPGP Applet</code>  的密码</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span><span class=\"token function\">edit-card</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Reader <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: canokeys<span class=\"token punctuation\">.</span>org OpenPGP PIV OATH 0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Application ID <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: xxxxxxxxxxxxxxxxxxxxxxxxxxx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Application <span class=\"token function\">type</span> <span class=\"token punctuation\">.</span>: OpenPGP</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Version <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: 3<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Manufacturer <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: CanoKeys</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Serial number <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: xxxxxxxx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Signature PIN <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: forced</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Key attributes <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: rsa2048 rsa2048 rsa2048</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Max<span class=\"token punctuation\">.</span> PIN lengths <span class=\"token punctuation\">.</span>: 64 64 64</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>PIN retry counter : 3 0 3</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Signature counter : 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>UIF setting <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: Sign=off Decrypt=off Auth=off</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Signature key <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: <span class=\"token namespace\">[none]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Encryption key<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: <span class=\"token namespace\">[none]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Authentication key: <span class=\"token namespace\">[none]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>General key info<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: <span class=\"token namespace\">[none]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 进入 Admin 模式</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>gpg/card> admin</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Admin commands are allowed</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>gpg/card> passwd</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>gpg: OpenPGP card no<span class=\"token punctuation\">.</span> xxxxxxxxxxxxxxxxxxxxxxxxxxx detected</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>1 <span class=\"token operator\">-</span> change PIN</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>2 <span class=\"token operator\">-</span> unblock PIN</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>3 <span class=\"token operator\">-</span> change Admin PIN</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>4 <span class=\"token operator\">-</span> <span class=\"token function\">set</span> the Reset Code</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Q <span class=\"token operator\">-</span> quit</pre></td></tr></table></figure><p>分别设置  <code>PIN</code> （默认  <code>123456</code> ） 和  <code>Admin PIN</code> （默认  <code>12345678</code> ），注意牢记，忘记后只能重置  <code>OpenPGP Applet</code> 。</p>\n<p>之后把各个子密钥导入对应插槽，请注意，这步是<strong>不可逆</strong>的，一但私钥导入智能卡并保存，<strong>本地私钥会被删除</strong>，无法再次恢复，因此务必确认已经正确完善备份。</p>\n<p>如果你使用了多个 Canokey，想同时向其中导入子密钥，请注意最后一步<strong>不要保存</strong>，直接强行退出，然后更换另一枚 Canokey 或其他智能卡，重复操作即可。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span><span class=\"token function\">edit-key</span> 787E848E1A98D086</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gpg <span class=\"token punctuation\">(</span>GnuPG<span class=\"token punctuation\">)</span> 2<span class=\"token punctuation\">.</span>3<span class=\"token punctuation\">.</span>4<span class=\"token punctuation\">;</span> Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> 2021 g10 Code GmbH</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>This is free software: you are free to change and redistribute it<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>There is NO WARRANTY<span class=\"token punctuation\">,</span> to the extent permitted by law<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Secret key is available<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>sec  ed25519/787E848E1A98D086</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     created: 2022-01-01  expires: never       usage: C</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     trust: ultimate      validity: ultimate</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ssb  ed25519/055917609C9C0D7B</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     created: 2022-01-01  expires: 2024-01-01  usage: S</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ssb  ed25519/05F4A6C335157258</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     created: 2022-01-01  expires: 2024-01-01  usage: A</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ssb  cv25519/C5B8214C3AD21C6C</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     created: 2022-01-01  expires: 2024-01-01  usage: E</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token namespace\">[ultimate]</span> <span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span> Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>gpg> key 1 <span class=\"token comment\"># 首先选中第一个子密钥</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>gpg> keytocard</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Please <span class=\"token function\">select</span> where to store the key:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span> Signature key</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token punctuation\">(</span>3<span class=\"token punctuation\">)</span> Authentication key</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Your selection? 1 <span class=\"token comment\"># 选择对应插槽</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 首先输入 OpenPGP 的密码，再输入 OpenPGP Applet 对应的 Admin PIN</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 之后先反选 key 1，再依次选择 key 2，key 3，重复操作即可</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>gpg> key 1</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>gpg> key 2</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>gpg> keytocard</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Please <span class=\"token function\">select</span> where to store the key:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   <span class=\"token punctuation\">(</span>3<span class=\"token punctuation\">)</span> Authentication key</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Your selection? 3</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>gpg> key 2</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>gpg> key 3</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>gpg> keytocard</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Please <span class=\"token function\">select</span> where to store the key:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   <span class=\"token punctuation\">(</span>2<span class=\"token punctuation\">)</span> Encryption key</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Your selection? 2</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>gpg> save <span class=\"token comment\"># 保存修改</span></pre></td></tr></table></figure><p>这时再次查看 Canokey 状态，确认导入成功。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>card-status</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Reader <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: canokeys<span class=\"token punctuation\">.</span>org OpenPGP PIV OATH 0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Application ID <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: xxxxxxxxxxxxxxxxxxxxxxxxxxx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Application <span class=\"token function\">type</span> <span class=\"token punctuation\">.</span>: OpenPGP</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Version <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: 3<span class=\"token punctuation\">.</span>4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Manufacturer <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: CanoKeys</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Serial number <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: xxxxxxxx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Signature PIN <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: forced</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Key attributes <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: rsa2048 rsa2048 rsa2048</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Max<span class=\"token punctuation\">.</span> PIN lengths <span class=\"token punctuation\">.</span>: 64 64 64</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>PIN retry counter : 3 0 3</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Signature counter : 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>UIF setting <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: Sign=off Decrypt=off Auth=off</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Signature key <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: E99F 3D15 7ACF 7E24 3DC8  FFE7 0559 1760 9C9C 0D7B</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      created <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: 2022-01-01 13:09:11</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Encryption key<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: E39E E067 3233 BD73 7ED1  15F1 C5B8 214C 3AD2 1C6C</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      created <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: 2022-01-01 13:09:32</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Authentication key: C4B9 7EEC 4060 F856 7A4D  2956 05F4 A6C3 3515 7258</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      created <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: 2022-01-01 13:09:49</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>General key info<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>: sub  ed25519/055917609C9C0D7B 2022-01-01 Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>sec   ed25519/787E848E1A98D086  created: 2022-01-01  expires: never</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ssb>  cv25519/055917609C9C0D7B  created: 2022-01-01  expires: 2024-01-01</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                card-no: F1D0 xxxxxxxx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ssb>  ed25519/05F4A6C335157258  created: 2022-01-01  expires: 2024-01-01</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                                card-no: F1D0 xxxxxxxx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>ssb>  ed25519/C5B8214C3AD21C6C  created: 2022-01-01  expires: 2024-01-01</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                card-no: F1D0 xxxxxxxx</pre></td></tr></table></figure><p>可以看到此时子密钥标识符为  <code>ssb&gt;</code> ，表示本地只有一个指向  <code>card-no: F1D0 xxxxxxxx</code>  智能卡的指针，已不存在私钥。现在可以删除掉主密钥了，请<strong>再次确认你已安全备份好主密钥</strong>。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>delete-secret-keys 787E848E1A98D086</pre></td></tr></table></figure><p>为确保安全，也可直接删除 gpg 的工作目录： <code>%APPDATA%\\gnupg</code> ，Linux/macOS:  <code>~/.gunpg</code> 。</p>\n<h3 id=\"使用-canokey\"><a class=\"anchor\" href=\"#使用-canokey\">#</a> 使用 Canokey</h3>\n<p>此时切换回日常使用的环境，首先导入公钥</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>import public-key<span class=\"token punctuation\">.</span>pub</pre></td></tr></table></figure><p>然后设置子密钥指向 Canokey</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span><span class=\"token function\">edit-card</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gpg/card> fetch</pre></td></tr></table></figure><p>此时查看本地的私钥，可以看到已经指向了 Canokey</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>fingerprint <span class=\"token operator\">--</span>keyid-format long <span class=\"token operator\">-</span>K</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>C:\\Users\\XXX\\AppData\\Roaming\\gnupg\\pubring<span class=\"token punctuation\">.</span>kbx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sec<span class=\"token comment\">#  ed25519/787E848E1A98D086 2022-01-01 [C]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      Key fingerprint = 6869 7537 A54B 1F0B FC05  E1D9 787E 848E 1A98 D086</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>uid                 <span class=\"token namespace\">[ultimate]</span> Editst &lt;editst@example<span class=\"token punctuation\">.</span>com></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ssb>  ed25519/055917609C9C0D7B 2022-01-01 <span class=\"token namespace\">[S]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      Key fingerprint = E99F 3D15 7ACF 7E24 3DC8  FFE7 0559 1760 9C9C 0D7B</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      Card serial no<span class=\"token punctuation\">.</span> = F1D0 xxxxxxxx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ssb>  ed25519/05F4A6C335157258 2022-01-01 <span class=\"token namespace\">[A]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      Key fingerprint = C4B9 7EEC 4060 F856 7A4D  2956 05F4 A6C3 3515 7258</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      Card serial no<span class=\"token punctuation\">.</span> = F1D0 xxxxxxxx</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ssb>  cv25519/C5B8214C3AD21C6C 2022-01-01 <span class=\"token namespace\">[E]</span> <span class=\"token namespace\">[expires: 2024-01-01]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      Key fingerprint = E39E E067 3233 BD73 7ED1  15F1 C5B8 214C 3AD2 1C6C</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      Card serial no<span class=\"token punctuation\">.</span> = F1D0 xxxxxxxx</pre></td></tr></table></figure><p>之后可以使用 gpg 进一步配置 Canokey，可以设置  <code>name</code> ， <code>forcesig</code>  等内容，同时可前往 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb25zb2xlLmNhbm9rZXlzLm9yZw==\">Canokey Web Console</span>  <code>Touch Policy</code>  配置每次使用时是否需要触摸以及缓存时间等。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg <span class=\"token operator\">--</span>card-edit</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gpg/card> admin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Admin commands are allowed</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gpg/card> help</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>quit           quit this menu</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>admin          show admin commands</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>help           show this help</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>list           list all available <span class=\"token keyword\">data</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>name           change card holder<span class=\"token string\">'s name</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>url            change URL to retrieve key</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>fetch          fetch the key specified in the card URL</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>login          change the login name</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>lang           change the language preferences</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>salutation     change card holder'</span>s salutation</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>cafpr          change a CA fingerprint</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>forcesig       toggle the signature force PIN flag</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>generate       generate new keys</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>passwd         menu to change or unblock the PIN</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>verify         verify the PIN and list all <span class=\"token keyword\">data</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>unblock        unblock the PIN <span class=\"token keyword\">using</span> a Reset Code</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>factory-reset  destroy all keys and <span class=\"token keyword\">data</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kdf-setup      setup KDF <span class=\"token keyword\">for</span> PIN authentication <span class=\"token punctuation\">(</span>on/single/off<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>key-attr       change the key attribute</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>uif            change the User Interaction Flag</pre></td></tr></table></figure><p>如果你使用了多个智能卡，切换后可能会因为私钥仍指向其他卡而出现问题，可以使用下面命令刷新  <code>Card serial no</code></p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg-<span class=\"token function\">connect-agent</span> <span class=\"token string\">\"scd serialno\"</span> <span class=\"token string\">\"learn --force\"</span> <span class=\"token operator\">/</span>bye</pre></td></tr></table></figure><h3 id=\"git-commit-签名\"><a class=\"anchor\" href=\"#git-commit-签名\">#</a> Git Commit 签名</h3>\n<p>首先确保 Git 本地配置以及 GitHub 中的邮箱信息包含在  <code>UID</code>  中，然后设置 Git 来指定使用子密钥中的签名（S）密钥。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>git config <span class=\"token operator\">--</span>global user<span class=\"token punctuation\">.</span>signingkey 055917609C9C0D7B</pre></td></tr></table></figure><p>之后在  <code>git commit</code>  时增加  <code>-S</code>  参数即可使用 gpg 进行签名。也可在配置中设置自动 gpg 签名，此处不建议全局开启该选项，因为有的脚本可能会使用  <code>git am</code>  之类的涉及到  <code>commit</code>  的命令，如果全局开启的话会导致问题。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>git config commit<span class=\"token punctuation\">.</span>gpgsign true</pre></td></tr></table></figure><p>如果提交到 GitHub，前往 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL2tleXM=\">GitHub SSH and GPG keys</span> 添加公钥。此处添加后，可以直接通过对应 GitHub ID 来获取公钥： <code>https://github.com/&lt;yourid&gt;.gpg</code></p>\n<h3 id=\"ssh-with-gpg-agent\"><a class=\"anchor\" href=\"#ssh-with-gpg-agent\">#</a> SSH with gpg agent</h3>\n<p>新版 gpg（最低 2.4.0 版本，对应 Gpg4win 4.1.0 版本）的 gpg agent 已支持 Win32-OpenSSH，无需使用其他软件即可使用目前 Windows 自带的 SSH 客户端进行公钥认证登录，需要手动配置开启该功能。</p>\n<p>首先在  <code>%AppData%\\gnupg\\gpg-agent.conf</code>  中写入一行：</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>enable-win32-openssh-support</pre></td></tr></table></figure><p>然后运行  <code>gpg -k --with-keygrip</code>  获取 [A] Subkey 的 Keygrip，写入  <code>%AppData%\\gnupg\\sshcontrol</code> ，重启 gpg agent：</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg-<span class=\"token function\">connect-agent</span> killagent <span class=\"token operator\">/</span>bye</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gpg-<span class=\"token function\">connect-agent</span> <span class=\"token operator\">/</span>bye</pre></td></tr></table></figure><p>查看 openSSH 读取到的公钥信息，把输出的公钥信息添加到服务器的  <code>~/.ssh/authorized_keys</code> 。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-add <span class=\"token operator\">-</span>L</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzFAR5puWAj0OflZJVzAJqejVEZCap2NhFJbzedYwX2 cardno:F1D0 xxxxxxxx</pre></td></tr></table></figure><p>此时连接  <code>ssh user@host</code> ，会弹出提示输入  <code>PIN</code>  的页面，如果  <code>Touch Policy</code>  开启的话还需要触摸一下 Canokey，之后就可以连接到服务器了。</p>\n<p>最后在启动目录  <code>%AppData%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup</code>  中增加一段 vbs 脚本，开机运行 gpg agent：</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">Set</span> WinScriptHost = CreateObject<span class=\"token punctuation\">(</span><span class=\"token string\">\"WScript.Shell\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WinScriptHost<span class=\"token punctuation\">.</span>Run Chr<span class=\"token punctuation\">(</span>34<span class=\"token punctuation\">)</span> &amp; <span class=\"token string\">\"C:\\Program Files (x86)\\GnuPG\\bin\\gpg-connect-agent.exe\"</span> &amp; Chr<span class=\"token punctuation\">(</span>34<span class=\"token punctuation\">)</span> &amp; <span class=\"token string\">\"/bye\"</span> <span class=\"token punctuation\">,</span> 0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">Set</span> WinScriptHost = Nothing</pre></td></tr></table></figure><p>如果需要在 WSL/WSL2 或转发认证，可以进一步参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3J1cG9yLWdpdGh1Yi93aW4tZ3BnLWFnZW50L3JlbGVhc2Vz\">win-gpg-agent</span> 的 GitHub 页面配置使用。</p>\n<h2 id=\"piv\"><a class=\"anchor\" href=\"#piv\">#</a> PIV</h2>\n<p><code>PIV Applet</code>  包含多个插槽，具体信息可以参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXJzLnl1Ymljby5jb20vUElWL0ludHJvZHVjdGlvbi9DZXJ0aWZpY2F0ZV9zbG90cy5odG1s\">PIV certificate slots</span>，前往 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb25zb2xlLmNhbm9rZXlzLm9yZw==\">Canokey Web Console</span>，进入  <code>PIV</code>  设置  <code>PIN</code> （默认  <code>123456</code> ）和  <code>Management Key</code> （需要 24 Bytes，默认  <code>010203040506070801020304050607080102030405060708</code> ）并牢记。</p>\n<h3 id=\"生成证书\"><a class=\"anchor\" href=\"#生成证书\">#</a> 生成证书</h3>\n<p>下面介绍两种不同的方法，可以根据自身需求选择。</p>\n<p>注意，受限于内存大小，Canokey PIV 证书<strong>最大支持 1335 Bytes</strong>，过大会导致无法导入 2022 年 6 月发售的 Canokey 据信已改进了这一问题，因本人目前不再持有 Canokey，无法测试。同时由于 Windows 系统的问题，Canokey PIV 目前只支持  <code>RSA2048</code>  算法， <code>NIST P-256/P-384</code>  算法生成的证书无法正常识别（没有 Canokey minidriver）。下面以  <code>RSA2048</code>  作为示例。</p>\n<h4 id=\"openssl\"><a class=\"anchor\" href=\"#openssl\">#</a> OpenSSL</h4>\n<p>首先安装生成  <code>RSA2048</code>  私钥，然后使用 OpenSSL 生成证书</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token operator\">-</span>t rsa <span class=\"token operator\">-</span>b 2048 <span class=\"token operator\">-</span>m PEM <span class=\"token operator\">-</span>f rsa2048<span class=\"token punctuation\">.</span>pem</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>openssl req <span class=\"token operator\">-</span>new <span class=\"token operator\">-</span>key rsa2048<span class=\"token punctuation\">.</span>pem <span class=\"token operator\">-</span>out editst<span class=\"token punctuation\">.</span>csr</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>openssl x509 <span class=\"token operator\">-</span>req <span class=\"token operator\">-</span>days 3650 <span class=\"token operator\">-in</span> editst<span class=\"token punctuation\">.</span>csr <span class=\"token operator\">-</span>signkey rsa2048<span class=\"token punctuation\">.</span>pem <span class=\"token operator\">-</span>out editst<span class=\"token punctuation\">.</span>crt</pre></td></tr></table></figure><p>之后安装  <code>yubikey-manager</code>  导入私钥和证书，目前  <code>ckman</code>  =  <code>ykman</code> ，这里使用  <code>9a</code>  插槽</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python <span class=\"token operator\">-</span>m pip install yubikey-manager</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv keys import 9a rsa2048<span class=\"token punctuation\">.</span>pem</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv certificates import 9a editst<span class=\"token punctuation\">.</span>crt</pre></td></tr></table></figure><p>还可以直接使用  <code>ykman</code>  调用 Canokey 来生成私钥和证书，注意这样生成的私钥是无法导出的。也可以在导入私钥的情况下直接调用第二个命令，只生成证书。</p>\n<p>下面  <code>-d</code>  参数为有效期，默认为 365 天， <code>-s</code>  参数为  <code>Subject for the certificate</code> ，必须传入，具体内容包括  <code>CN: CommonName, OU: OrganizationalUnit, O: Organization, L: Locality, S: StateOrProvinceName, C: CountryName</code></p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv keys generate 9a rsa2048<span class=\"token punctuation\">.</span>pub</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv certificates generate 9a rsa2048<span class=\"token punctuation\">.</span>pub <span class=\"token operator\">-</span>s <span class=\"token string\">\"CN=Editst, C=CN\"</span> <span class=\"token operator\">-</span>d 3650</pre></td></tr></table></figure><p>完成后重新插拔 Canokey，Windows 前往  <code>certmgr.msc</code> ，在个人 - 证书中可以看到已经有了刚才生成的证书。</p>\n<h4 id=\"certreq\"><a class=\"anchor\" href=\"#certreq\">#</a> certreq</h4>\n<p>在 Windows 环境下虽然没有自带的 OpenSSL 组件，但是提供了强大的  <code>certreq</code>  组件来生成证书。下面直接给出参考的配置，可以自行修改，也可以前往 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy1zZXJ2ZXIvYWRtaW5pc3RyYXRpb24vd2luZG93cy1jb21tYW5kcy9jZXJ0cmVxXzE=\">certreq docs</span> 查看更详细地参数说明。</p>\n<p>其中  <code>Subject</code>  具体内容包括  <code>CN: CommonName, OU: OrganizationalUnit, O: Organization, L: Locality, S: StateOrProvinceName, C: CountryName</code> ，可以自行配置。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token namespace\">[NewRequest]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Subject = <span class=\"token string\">\"CN=Editst\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>KeyLength = 2048</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Exportable = TRUE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>HashAlgorithm = SHA256</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>KeySpec = <span class=\"token string\">\"AT_KEYEXCHANGE\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>KeyUsage = <span class=\"token string\">\"CERT_KEY_ENCIPHERMENT_KEY_USAGE\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>KeyUsageProperty = <span class=\"token string\">\"NCRYPT_ALLOW_DECRYPT_FLAG\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>RequestType = Cert</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ValidityPeriodUnits = 5</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ValidityPeriod = Years</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>SMIME = FALSE</pre></td></tr></table></figure><p>保存上面的配置文件到  <code>cert.ini</code> ，之后使用 certreq 生成证书，注意这一步生成的  <code>cert_req.req</code>  没啥用，直接删除即可</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certreq <span class=\"token operator\">-</span>new cert<span class=\"token punctuation\">.</span>ini cert_req<span class=\"token punctuation\">.</span>req</pre></td></tr></table></figure><p>此时生成的证书已经自动安装在系统中，前往  <code>certmgr.msc</code> ，在个人 - 证书中可以看到已经有了刚才生成的证书。右键选择<strong>所有任务 - 导出</strong>，在导出向导中选择<strong>导出私钥</strong>即可获得完整的证书和私钥文件  <code>cert.pfx</code> 。</p>\n<p>之后导入需要使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXJzLnl1Ymljby5jb20veXViaWNvLXBpdi10b29sL1JlbGVhc2VzLw==\">yubikey-piv-tool</span>，下载安装后手动添加程序路径到环境变量中： <code>C:\\Program Files\\Yubico\\Yubico PIV Tool\\bin</code> ，之后把证书和私钥导入到 Canokrey</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yubico-piv-tool <span class=\"token operator\">-</span>r Canokey <span class=\"token operator\">-</span>a <span class=\"token function\">import-key</span> <span class=\"token operator\">-</span>a <span class=\"token function\">import-certificate</span> <span class=\"token operator\">-</span>s 9e <span class=\"token operator\">-</span>K PKCS12 <span class=\"token operator\">-</span>k <span class=\"token operator\">-</span>i cert<span class=\"token punctuation\">.</span>pfx</pre></td></tr></table></figure><p>需要首先输入导出证书时的密码，之后再输入  <code>Management Key</code></p>\n<h3 id=\"ssh-with-piv\"><a class=\"anchor\" href=\"#ssh-with-piv\">#</a> SSH with PIV</h3>\n<p>前往 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2J1cHRjenEvV2luQ3J5cHRTU0hBZ2VudA==\">WinCrypt SSH Agent</span> 下载并运行，此时查看  <code>ssh-agent</code>  读取到的公钥信息，把输出的公钥信息添加到服务器的  <code>~/.ssh/authorized_keys</code></p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$Env</span>:SSH_AUTH_SOCK=<span class=\"token string\">\"\\\\.\\pipe\\openssh-ssh-agent\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ssh-add <span class=\"token operator\">-</span>L</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCYSnYY1UFzct9qi7QGNsE9GRJXmsy7HNLxHHO0uxuZTKQUT2OHrCHwVoeahPZRGwOXqxiziR6MxMVwK8mmfpM/2iRwkJhiW4AmeAA5s3zeO9sdZTYRzb9njCaa7uqOER6fbgW99ctp2LwsKxG0z2TvBgh+fwum96APggozLbapfweiWbbmymJ4J60p7yP/5a8Uh9AABNijp3iCmpnydICuWLG4Vtj4vMJ4NGNH5POY7qU0lvBULEXMXaFRoZrv93VRaj0hw2GOtgd9IdB+edSmze/vjJ+eodk5tqjLATi2BxlvSKPHDb14a34b5JK5idMUwlRfOOvOA10nZ7+kZetX Editst</pre></td></tr></table></figure><p>此时连接  <code>ssh user@host</code> ，会弹出提示输入  <code>PIN</code>  的页面，注意此时输入的是  <code>PIV Applet PIN</code> ，输入后即可成功连接服务器。</p>\n<p>注意这种使用方法与 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9lZGl0c3QuY29tLzIwMjIvY2Fub2tleS1ndWlkZS8jU1NILXdpdGgtZ3BnLWFnZW50\">SSH with gpg-agent</span> 并不兼容，选择其中一种使用即可。</p>\n<h3 id=\"bitlokcer-with-piv\"><a class=\"anchor\" href=\"#bitlokcer-with-piv\">#</a> BitLokcer with PIV</h3>\n<p>如果已经按照上一步生成了证书，需要修改注册表来允许自签名证书，在注册表  <code>HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\FVE</code>  下新建一个  <code>DWORD</code>  的值，名称为  <code>SelfSignedCertificates</code> ，数值数据为  <code>1</code> 。</p>\n<p>或者直接保存下面的注册表配置文件为  <code>selfsig.reg</code> ，然后导入。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Windows Registry Editor Version 5<span class=\"token punctuation\">.</span>00</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token namespace\">[HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\FVE]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token string\">\"SelfSignedCertificates\"</span>=dword:00000001</pre></td></tr></table></figure><p>注意，需要验证智能卡中<strong>存有证书对应的私钥</strong>，否则会导致可以添加智能卡，但在解锁时失败。运行下面命令，确保输出信息中<strong>包含私钥验证测试通过</strong>信息。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certutil <span class=\"token operator\">-</span>scinfo</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 应含有下面输出</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>私钥验证</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Microsoft Smart Card Key Storage Provider: KeySpec=0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>AES256+RSAES_OAEP<span class=\"token punctuation\">(</span>RSA:CNG<span class=\"token punctuation\">)</span> 测试通过</pre></td></tr></table></figure><p>BitLocker 不要求证书具备 EKU 属性，但是如果已为证书配置了该属性，则必须将前往组策略<strong>计算机配置 - 管理模板 - Windows 组件 - BitLocker 驱动器加密</strong>，设置<strong>验证智能卡证书使用合规性</strong>为已启用，同时为 BitLocker 配置的对象标识符 (OID) 匹配的 OID。</p>\n<p>如果遇到其他问题请尝试执行下面命令，初始化  <code>Card Holder Unique Identifier</code>  和  <code>CCC</code> 。</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv objects generate chuid</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ykman <span class=\"token operator\">-</span>r Canokey piv objects generate ccc</pre></td></tr></table></figure><p>之后启用 BitLocker 时选择<strong>使用智能卡解锁驱动器</strong>即可，对于已启用 BitLocker 的驱动器，也可以通过<strong>管理 BitLocker</strong> 来添加智能卡。</p>\n<p>感谢你看到这里，如有任何问题欢迎留言或邮件联系  <code>mail@sakurame.eu.org</code> ，或者尝试从下面链接中寻找答案。</p>\n<h2 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h2>\n<ul>\n<li>2021 年，用更现代的方法使用 PGP<span class=\"exturl\" data-url=\"aHR0cHM6Ly91bHljLmdpdGh1Yi5pby8yMDIxLzAxLzEzLzIwMjElRTUlQjklQjQtJUU3JTk0JUE4JUU2JTlCJUI0JUU3JThFJUIwJUU0JUJCJUEzJUU3JTlBJTg0JUU2JTk2JUI5JUU2JUIzJTk1JUU0JUJEJUJGJUU3JTk0JUE4UEdQLSVFNCVCOCU4QS8=\">（上）</span>，<span class=\"exturl\" data-url=\"aHR0cHM6Ly91bHljLmdpdGh1Yi5pby8yMDIxLzAxLzE4LzIwMjElRTUlQjklQjQtJUU3JTk0JUE4JUU2JTlCJUI0JUU3JThFJUIwJUU0JUJCJUEzJUU3JTlBJTg0JUU2JTk2JUI5JUU2JUIzJTk1JUU0JUJEJUJGJUU3JTk0JUE4UEdQLSVFNCVCOCVBRC8=\">（中）</span>，<span class=\"exturl\" data-url=\"aHR0cHM6Ly91bHljLmdpdGh1Yi5pby8yMDIxLzAxLzI2LzIwMjElRTUlQjklQjQtJUU3JTk0JUE4JUU2JTlCJUI0JUU3JThFJUIwJUU0JUJCJUEzJUU3JTlBJTg0JUU2JTk2JUI5JUU2JUIzJTk1JUU0JUJEJUJGJUU3JTk0JUE4UEdQLSVFNCVCOCU4Qi8=\">（下）</span></li>\n<li>用 PGP 保护代码完整性：\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTk1MjQtMS5odG1s\">（一）： 基本概念和工具</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTk1MjktMS1yZWwuaHRtbA==\">（二）：生成你的主密钥</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTk2MDctMS5odG1s\">（三）：生成 PGP 子密钥</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTEwNDAyLTEtcmVsLmh0bWw=\">（四）：将主密钥移到离线存储中</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTEwNDE1LTEuaHRtbA==\">（五）：将子密钥移到一个硬件设备中</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTEwNDIxLTEuaHRtbA==\">（六）：在 Git 上使用 PGP</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTEwNDMyLTEuaHRtbA==\">（七）：保护在线帐户</span></li>\n</ul>\n</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmNhbm9rZXlzLm9yZy91c2VyZ3VpZGUv\">Documentation for Canokey</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pYW10d3ouZ2l0Ym9va3MuaW8veXViaWtleS1oYW5kYm9vay1jaGluZXNlL2NvbnRlbnQv\">Yubikey 使用手册</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYWIuamlua2FuLm9yZy8yMDIxLzA4LzAxL3VzaW5nLWdwZy1mb3Itc3NoLWF1dGhlbnRpY2F0aW9uLW9uLXdpbmRvd3MtMTAv\">在 Windows 10 上用 GPG 完成 SSH 认证</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tZWNoYW51cy5pby9rZS1uZW5nLXNoaS16dWktaGFvLWRlLXl1YmlrZXktZ3BnLXNzaC16aGktbmVuZy1xaWEtamlhby1jaGVuZy8=\">可能是最好的 Yubikey + GPG/SSH 智能卡教程</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9lZGl0c3QuY29tLzIwMjIvY2Fub2tleS1ndWlkZS8=\">Canokey 指南：OTP，FIDO2，PGP 与 PIV</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oay52MmV4LmNvbS90LzYwNzQxOA==\">在 Windows 上愉快的使用 Yubikey 登录 SSH</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ud24ubW9lL3Bvc3RzL3l1YmlrZXktZXhhbXBsZXMvIyVFNCVCRCU5QyVFNCVCOCVCQSVFNSVBRiU4NiVFOSU5MiVBNSVFOCVCRiU5QiVFOCVBMSU4Q1NTSCVFOSVBQSU4QyVFOCVBRiU4MQ==\">应用 Yubikey 的 N 种方法</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0FzdGVyaXNNb25vL2Z0c2FmZS1rOXBsdXMtdXNlci1ndWlkZQ==\">ftsafe-k9plus-user-guide</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly90b3Rvcm8uaW5rL3l1YmlrZXktbW9yZS5odG1s\">YubiKey 与 BitLocker</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uYXRoYW5hZWxmcmV5LmNvbS8yMDIxLzAxLzA5L3NldHRpbmctdXAtYml0bG9ja2VyLXdpdGgteXViaWtleS1hcy1zbWFydC1jYXJkLw==\">Setting Up BitLocker with YubiKey as Smart Card</span></li>\n</ul>\n",
            "tags": [
                "隐私"
            ]
        },
        {
            "id": "https://sakurame.eu.org/2023/06/09/privacy/the-pgp-problem/",
            "url": "https://sakurame.eu.org/2023/06/09/privacy/the-pgp-problem/",
            "title": "the-pgp-problem",
            "date_published": "2023-06-09T07:37:50.000Z",
            "content_html": "<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYXRhY29yYS5taWNyby5ibG9nLw==\">Latacora</span></p>\n<p>​\t\t \t\t \t\t\t<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYXRhY29yYS5taWNyby5ibG9nL2Fib3V0Lw==\">About</span> \t\t \t \t\t \t\t\t<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYXRhY29yYS5taWNyby5ibG9nL2FyY2hpdmUv\">Archive</span></p>\n<h1 id=\"the-pgp-problem\"><a class=\"anchor\" href=\"#the-pgp-problem\">#</a> The PGP Problem</h1>\n<p>Jul 16, 2019</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNyeXB0b2dyYXBoeWVuZ2luZWVyaW5nLmNvbS8yMDE0LzA4LzEzL3doYXRzLW1hdHRlci13aXRoLXBncC8=\">Cryptography engineers have been tearing their hair out over PGP’s deficiencies</span> for (literally) decades. When other kinds of engineers get wind of  this, they’re shocked. PGP is bad? Why do people keep telling me to use  PGP? The answer is that they shouldn’t be telling you that, because PGP  is bad and needs to go away.</p>\n<p>There are, as you’re about to see, lots of problems with PGP.  Fortunately, if you’re not morbidly curious, there’s a simple  meta-problem with it: it was designed in the 1990s, before serious  modern cryptography. No competent crypto engineer would design a system  that looked like PGP today, nor tolerate most of its defects in any  other design. Serious cryptographers have largely given up on PGP and  don’t spend much time publishing on it anymore (<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9zeXN0ZW0vZmlsZXMvY29uZmVyZW5jZS91c2VuaXhzZWN1cml0eTE4L3NlYzE4LXBvZGRlYm5pYWsucGRm\">with a notable exception</span>). Well-understood problems in PGP have gone unaddressed for over a decade because of this.</p>\n<p>Two quick notes: first, we wrote this for engineers, not lawyers and  activists. Second: “PGP” can mean a bunch of things, from the <span class=\"exturl\" data-url=\"aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQ4ODA=\">OpenPGP standard</span> to its reference implementation in GnuPG. We use the term “PGP” to cover all of these things.</p>\n<h2 id=\"the-problems\"><a class=\"anchor\" href=\"#the-problems\">#</a> The Problems</h2>\n<h3 id=\"absurd-complexity\"><a class=\"anchor\" href=\"#absurd-complexity\">#</a> Absurd Complexity</h3>\n<p>For reasons none of us here in the future understand, PGP has a  packet-based structure. A PGP message (in a “.asc” file) is an archive  of typed packets. There are <span class=\"exturl\" data-url=\"aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQ4ODAjcGFnZS0xMw==\">at least 8 different ways</span> of encoding the length of a packet, depending on whether you’re using  “new” or “old” format packets. The “new format” packets have  variable-length lengths, like BER (try to write a PGP implementation and you may wish for the sweet release of ASN.1). Packets can have  subpackets. There are overlapping variants of some packets. The most  recent keyserver attack happened because GnuPG <span class=\"exturl\" data-url=\"aHR0cHM6Ly90aHJlYWRyZWFkZXJhcHAuY29tL3RocmVhZC8xMTQ3MTYyNTgzOTY5MDA5NjY0Lmh0bWw=\">accidentally went quadratic</span> in parsing keys, which also follow this deranged format.</p>\n<p>That’s just the encoding. The actual system doesn’t get simpler.  There are keys and subkeys. Key IDs and key servers and key signatures.  Sign-only and encrypt-only. Multiple “key rings”. Revocation  certificates. Three different compression formats. This is all before we get to smartcard support.</p>\n<h3 id=\"swiss-army-knife-design\"><a class=\"anchor\" href=\"#swiss-army-knife-design\">#</a> Swiss Army Knife Design</h3>\n<p>If you’re stranded in the woods and, I don’t know, need to repair  your jean cuffs, it’s handy if your utility knife has a pair of  scissors. But nobody who does serious work uses their multitool scissors regularly.</p>\n<p>A Swiss Army knife does a bunch of things, all of them poorly. PGP  does a mediocre job of signing things, a relatively poor job of  encrypting them with passwords, and a pretty bad job of encrypting them  with public keys. PGP is not an especially good way to securely transfer a file. It’s a clunky way to sign packages. It’s not great at  protecting backups. It’s a downright dangerous way to converse in secure messages.</p>\n<p>Back in the MC Hammer era from which PGP originates, “encryption” was its own special thing; there was one tool to send a file, or to back up a directory, and another tool to encrypt and sign a file. Modern  cryptography doesn’t work like this; it’s purpose built. Secure  messaging wants crypto that is different from secure backups or package  signing.</p>\n<h3 id=\"mired-in-backwards-compatibility\"><a class=\"anchor\" href=\"#mired-in-backwards-compatibility\">#</a> Mired In Backwards Compatibility</h3>\n<p>PGP predates modern cryptography; there are Hanson albums that have  aged better. If you’re lucky, your local GnuPG defaults to 2048-bit RSA, the 64-bit-block CAST5 cipher in CFB, and the OpenPGP MDC checksum  (about which more later). If you encrypt with a password rather than  with a public key, the OpenPGP protocol specifies PGP’s S2K password  KDF. These are, to put it gently, not the primitives a cryptography  engineer would select for a modern system.</p>\n<p>We’ve learned a lot since Steve  Urkel graced the airwaves during  ABC’s TGIF: that you should authenticate your ciphertexts (and avoid CFB mode) would be an obvious example, but also that 64-bit block ciphers  are bad, that we can do much better than RSA, that mixing compression  and encryption is dangerous, and that KDFs should be both time- and  memory-hard.</p>\n<p>Whatever the OpenPGP RFCs may say, you’re probably not doing any of  these things if you’re using PGP, nor can you predict when you will.  Take AEAD ciphers: the Rust-language Sequoia PGP defaulted to the  AES-EAX AEAD mode, which is great, and nobody can read those messages  because most PGP installs don’t know what EAX mode is, which is not  great. Every well-known bad cryptosystem eventually sprouts an RFC  extension that supports curves or AEAD, so that its proponents can claim on message boards that they support modern cryptography. RFC’s don’t  matter: only the installed base does. We’ve understood authenticated  encryption for 2 decades, and PGP is old enough to buy me drinks; enough excuses.</p>\n<p>You can have backwards compatibility with the 1990s or you can have sound cryptography; <em>you can’t have both</em>.</p>\n<h3 id=\"obnoxious-ux\"><a class=\"anchor\" href=\"#obnoxious-ux\">#</a> Obnoxious UX</h3>\n<p>We can’t say this any better than Ted Unangst:</p>\n<blockquote>\n<p>There was a PGP usability study conducted a few years ago where a  group of technical people were placed in a room with a computer and  asked to set up PGP. Two hours later, they were never seen or heard from again.</p>\n</blockquote>\n<p>If you’d like empirical data of your own to back this up, here’s an  experiment you can run: find an immigration lawyer and talk them through the process of getting Signal working on their phone. You probably  don’t suddenly smell burning toast. Now try doing that with PGP.</p>\n<h3 id=\"long-term-secrets\"><a class=\"anchor\" href=\"#long-term-secrets\">#</a> Long-Term Secrets</h3>\n<p>PGP begs users to keep a practically-forever root key tied to their  identity. It does this by making keys annoying to generate and exchange, by encouraging “key signing parties”, and by creating a “web of trust”  where keys depend on other keys.</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmZpbGlwcG8uaW8vZ2l2aW5nLXVwLW9uLWxvbmctdGVybS1wZ3Av\">Long term keys are almost never what you want</span>. If you keep using a key, it eventually gets exposed. You want the blast radius of a compromise to be as small as possible, and, just as  importantly, you don’t want users to hesitate even for a moment at the  thought of rolling a new key if there’s any concern at all about the  safety of their current key.</p>\n<p>The PGP cheering section will immediately reply “that’s why you keep  keys on a Yubikey”. To a decent first approximation, nobody in the whole world uses the expensive Yubikeys that do this, and you can’t imagine a future in which that changes (we can barely get U2F rolled out, and  those keys are disposable). We can’t accept bad cryptosystems just to  make Unix nerds feel better about their toys.</p>\n<h3 id=\"broken-authentication\"><a class=\"anchor\" href=\"#broken-authentication\">#</a> Broken Authentication</h3>\n<p>More on PGP’s archaic primitives: way back in 2000, the OpenPGP  working group realized they needed to authenticate ciphertext, and that  PGP’s signatures weren’t accomplishing that. So OpenPGP invented <span class=\"exturl\" data-url=\"aHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzQ4ODAjc2VjdGlvbi01LjE0\">the MDC system</span>: PGP messages with MDCs attach a SHA-1 of the plaintext to the plaintext, which is then encrypted (as normal) in CFB mode.</p>\n<p>If you’re wondering how PGP gets away with this when modern systems  use relatively complex AEAD modes (why can’t everyone just tack a SHA-1  to their plaintext), you’re not alone. Where to start with this Rube  Goldberg contraption? The PGP MDC can be stripped off messages –– it was encoded in such a way that you can simply chop off the last 22 bytes of the ciphertext to do that. To retain backwards compatibility with  insecure older messages, PGP introduced a new packet type to signal that the MDC needs to be validated; if you use the wrong type, the MDC  doesn’t get checked. Even if you do, the new SEIP packet format is close enough to the insecure SE format that you can potentially trick readers into downgrading; <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYWlsYXJjaGl2ZS5pZXRmLm9yZy9hcmNoL21zZy9vcGVucGdwL3RCMDB2TzVyLXFuZVg5d3oxeHozbmV0cFhWVQ==\">Trevor Perrin worked the SEIP out to 16 whole bits of security.</span></p>\n<p>And, finally, even if everything goes right, the reference PGP  implementation will (wait for it) release unauthenticated plaintext to  callers, <em>even if the MDC doesn’t match</em>.</p>\n<h3 id=\"incoherent-identity\"><a class=\"anchor\" href=\"#incoherent-identity\">#</a> Incoherent Identity</h3>\n<p>PGP is an application. It’s a set of integrations with other  applications. It’s a file format. It’s also a social network, and a  subculture.</p>\n<p>PGP pushes notion of a cryptographic identity. You generate a key,  save it in your keyring, print its fingerprint on your business card,  and publish it to a keyserver. You sign other people’s keys. They in  turn may or may not rely on your signatures to verify other keys. Some  people go out of their way to meet other PGP users in person to exchange keys and more securely attach themselves to this “web of trust”. Other  people organize “key signing parties”. The image you’re conjuring in  your head of that accurately explains how hard it is to PGP’s devotees  to switch to newer stuff.</p>\n<p>None of this identity goop works. Not the key signing web of trust,  not the keyservers, not the parties. Ordinary people will trust anything that looks like a PGP key no matter where it came from – how could they not, when even an expert would have a hard time articulating how to  evaluate a key? Experts don’t trust keys they haven’t exchanged  personally. Everyone else relies on centralized authorities to  distribute keys. PGP’s key distribution mechanisms are theater.</p>\n<h3 id=\"leaks-metadata\"><a class=\"anchor\" href=\"#leaks-metadata\">#</a> Leaks Metadata</h3>\n<p>Forget the email debacle for a second (we’ll get to that later). PGP  by itself leaks metadata. Messages are (in normal usage) linked directly to key identifiers, which are, throughout PGP’s cobweb of trust, linked to user identity. Further, a rather large fraction of PGP users make  use of keyservers, which can themselves leak to the network the  identities of which PGP users are communicating with each other.</p>\n<h3 id=\"no-forward-secrecy\"><a class=\"anchor\" href=\"#no-forward-secrecy\">#</a> No Forward Secrecy</h3>\n<p>A good example of that last problem: secure messaging crypto demands  forward secrecy. Forward secrecy means that if you lose your key to an  attacker today, they still can’t go back and read yesterday’s messages;  they had to be there with the key yesterday to read them. In modern  cryptography engineering, we assume our adversary is recording  everything, into infinite storage. PGP’s claimed adversaries include  world governments, many of whom are certainly doing exactly that.  Against serious adversaries and without forward secrecy, breaches are a  question of “when”, not “if”.</p>\n<p>To get forward secrecy in practice, you typically keep two secret  keys: a short term session key and a longer-term trusted key. The  session key is ephemeral (usually the product of a DH exchange) and the  trusted key signs it, so that a man-in-the-middle can’t swap their own  key in. It’s theoretically possible to achieve a facsimile of forward  secrecy using the tools PGP provides. Of course, pretty much nobody does this.</p>\n<h3 id=\"clumsy-keys\"><a class=\"anchor\" href=\"#clumsy-keys\">#</a> Clumsy Keys</h3>\n<p>An OpenBSD signify(1) public key is a Base64 string short enough to  fit in the middle of a sentence in an email; the private key, which  isn’t an interchange format, is just a line or so longer. A PGP public  key is a whole giant Base64 document; if you’ve used them often, you’re  probably already in the habit of attaching them rather than pasting them into messages so they don’t get corrupted. Signify’s key is a  state-of-the-art Ed25519 key; PGP’s is a weaker RSA key.</p>\n<p>You might think this stuff doesn’t matter, but it matters a lot;  orders of magnitude more people use SSH and manage SSH keys than use  PGP. SSH keys are trivial to handle; PGP’s are not.</p>\n<h3 id=\"negotiation\"><a class=\"anchor\" href=\"#negotiation\">#</a> Negotiation</h3>\n<p>PGP supports ElGamal. PGP supports RSA. PGP supports the NIST  P-Curves. PGP supports Brainpool. PGP supports Curve25519. PGP supports  SHA-1. PGP supports SHA-2. PGP supports RIPEMD160. PGP supports IDEA.  PGP supports 3DES. PGP supports CAST5. PGP supports AES. There is no way this is a complete list of what PGP supports.</p>\n<p>If we’ve learned 3 important things about cryptography design in the  last 20 years, at least 2 of them are that negotiation and compatibility are evil. The flaws in cryptosystems tend to appear in the joinery, not the lumber, and expansive crypto compatibility increases the amount of  joinery. Modern protocols like TLS 1.3 are jettisoning backwards  compatibility with things like RSA, not adding it. New systems support <em>just a single suite of primitives</em>, and a simple version number. If one of those primitives fails, you bump the version and chuck the old protocol all at once.</p>\n<p>If we’re unlucky, and people are still using PGP 20 years from now,  PGP will be the only reason any code anywhere includes CAST5. We can’t  say this more clearly or often enough: you can have backwards  compatibility with the 1990s or you can have sound cryptography; you  can’t have both.</p>\n<h3 id=\"janky-code\"><a class=\"anchor\" href=\"#janky-code\">#</a> Janky Code</h3>\n<p>The de facto standard implementation of PGP is GnuPG. GnuPG is not  carefully built. It’s a sprawling C-language codebase with duplicative  functionality (write-ups of the most recent SKS key parsing denial of  service noted that it has multiple key parsers, for instance) with a <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3ZlZGV0YWlscy5jb20vdnVsbmVyYWJpbGl0eS1saXN0L3ZlbmRvcl9pZC00NzExL0dudXBnLmh0bWw=\">long track record of CVEs</span> ranging from memory corruption to cryptographic side channels. It has  at times been possible to strip authenticators off messages without  GnuPG noticing. It’s been possible to feed it keys that don’t  fingerprint properly without it noticing. The 2018 Efail vulnerability  was a result of it releasing unauthenticated plaintext to callers. GnuPG is not good.</p>\n<p>GnuPG is also effectively the reference implementation for PGP, and  also the basis for most other tools that integrate PGP cryptography. It  isn’t going anywhere. To rely on PGP is to rely on GPG.</p>\n<h2 id=\"the-answers\"><a class=\"anchor\" href=\"#the-answers\">#</a> The Answers</h2>\n<p>One of the rhetorical challenges of persuading people to stop using PGP is that there’s no one thing you can replace it with, <em>nor should there be</em>. What you should use instead depends on what you’re doing.</p>\n<h3 id=\"talking-to-people\"><a class=\"anchor\" href=\"#talking-to-people\">#</a> Talking To People</h3>\n<p>Use Signal. Or Wire, or WhatsApp, or some other Signal-protocol-based secure messenger.</p>\n<p>Modern secure messengers are purpose-built around messaging. They use privacy-preserving authentication handshakes, repudiable messages, <em>cryptographic ratchets</em> that rekey on every message exchange, and, of course, modern encryption primitives. Messengers are trivially easy to use and there’s no fussing over keys and subkeys. If you use Signal, you get even more than that:  you get a system so paranoid about keeping private metadata off servers  that it tunnels Giphy searches to avoid traffic analysis attacks, and  until relatively recently didn’t even support user profiles.</p>\n<h3 id=\"encrypting-email\"><a class=\"anchor\" href=\"#encrypting-email\">#</a> Encrypting Email</h3>\n<p>Don’t.</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uZXdzLnljb21iaW5hdG9yLmNvbS9pdGVtP2lkPTE2MDg4Mzg2\">Email is insecure</span>. Even with PGP, it’s default-plaintext, which means that even if you do  everything right, some totally reasonable person you mail, doing totally reasonable things, will invariably CC the quoted plaintext of your  encrypted message to someone else (we don’t know a PGP email user who  hasn’t seen this happen). PGP email is forward-insecure. Email metadata, including the subject (which is literally message content), are always  plaintext.</p>\n<p>If you needed another reason, <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9zeXN0ZW0vZmlsZXMvY29uZmVyZW5jZS91c2VuaXhzZWN1cml0eTE4L3NlYzE4LXBvZGRlYm5pYWsucGRm\">read the Efail paper</span>. The GnuPG community, <span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTgxMjI1MjE0NzMwL2h0dHBzOi8vZmxha2VkLnNvY2twdXBwZXQub3JnLzIwMTgvMDUvMTYvYS11bmlmaWVkLXRpbWVsaW5lLmh0bWw=\">which mishandled the Efail disclosure</span>, talks this research down a lot, but it was accepted at Usenix Security  (one of the top academic software security venues) and at Black Hat USA (<em>the</em> top industry software security venue), was one of the best  cryptographic attacks of the last 5 years, and is a pretty devastating  indictment of the PGP ecosystem. As you’ll see from the paper, S/MIME  isn’t better.</p>\n<p>This isn’t going to get fixed. To make actually-secure email, you’d  have to tunnel another protocol over email (you’d still be conceding  traffic analysis attacks). At that point, why bother pretending?</p>\n<p>Encrypting email is asking for a calamity. Recommending email  encryption to at-risk users is malpractice. Anyone who tells you it’s  secure to communicate over PGP-encrypted email is putting their weird  preferences ahead of your safety.</p>\n<h3 id=\"sending-files\"><a class=\"anchor\" href=\"#sending-files\">#</a> Sending Files</h3>\n<p>Use <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3dhcm5lci9tYWdpYy13b3JtaG9sZQ==\">Magic Wormhole</span>. Wormhole clients use a one-time password-authenticated key exchange  (PAKE) to encrypt files to recipients. It’s easy (for nerds, at least),  secure, and fun: we haven’t introduced wormhole to anyone who didn’t  start gleefully wormholing things immediately just like we did.</p>\n<p>Someone stick a Windows installer on a Go or Rust implementation of  Magic Wormhole right away; it’s too great for everyone not to have.</p>\n<p>If you’re working with lawyers and not with technologists, Signal  does a perfectly cromulent job of securing file transfers. Put a Signal  number on your security page to receive bug bounty reports, not a PGP  key.</p>\n<h3 id=\"encrypting-backups\"><a class=\"anchor\" href=\"#encrypting-backups\">#</a> Encrypting Backups</h3>\n<p>Use Tarsnap. <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudGFyc25hcC5jb20vZGVzaWduLmh0bWw=\">Colin can tell you all about how Tarsnap is optimized to protect backups.</span> Or really, use any other encrypted backup tool that lots of other  people use; they won’t be as good as Tarsnap but they’ll all do a better job than PGP will.</p>\n<p>Need offline backups? Use encrypted disk images; they’re built into modern Windows, Linux, and macOS. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb2NrcHVwcGV0Lm9yZy9ibG9nLzIwMTQvMDQvMzAveW91LWRvbnQtd2FudC14dHMv\">Full disk encryption isn’t great</span>, but it works fine for this use case, and it’s easier and safer than PGP.</p>\n<h3 id=\"signing-packages\"><a class=\"anchor\" href=\"#signing-packages\">#</a> Signing Packages</h3>\n<p>Use Signify/Minisign. <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cub3BlbmJzZC5vcmcvcGFwZXJzL2JzZGNhbi1zaWduaWZ5Lmh0bWw=\">Ted Unangst will tell you all about it.</span> It’s what OpenBSD uses to sign packages. It’s extremely simple and uses modern signing. <span class=\"exturl\" data-url=\"aHR0cHM6Ly9qZWRpc2N0MS5naXRodWIuaW8vbWluaXNpZ24v\">Minisign</span>, from Frank Denis, the libsodium guy, brings the same design to Windows  and macOS; it has bindings for Go, Rust, Python, Javascript, and .NET;  it’s even compatible with Signify.</p>\n<h3 id=\"encrypting-application-data\"><a class=\"anchor\" href=\"#encrypting-application-data\">#</a> Encrypting Application Data</h3>\n<p>Use  <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plZGlzY3QxL2xpYnNvZGl1bQ==\">libsodium</span> It builds everywhere, has interface that’s designed to be hard to misuse,  and you won’t have to shell out to a binary to use it.</p>\n<h3 id=\"encrypting-files\"><a class=\"anchor\" href=\"#encrypting-files\">#</a> Encrypting Files</h3>\n<p>This really is a problem. If you’re/not/making a backup, and you’re  /not/archiving something offline for long-term storage, and you’re  /not/encrypting in order to securely send the file to someone else, and  you’re /not/encrypting virtual drives that you mount/unmount as needed  to get work done, then there’s no one good tool that does this now.  Filippo Valsorda is working on “<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vZG9jdW1lbnQvZC8xMXlIb20yMENyc3VYOEtRSlhCQncwNHM4MFVuanY4ekNnX0E3c1BBWF85WS92aWV3\">age</span>” for these use cases, and I’m super optimistic about it, but it’s not there yet.</p>\n<p><em>Update, February 2020</em></p>\n<p>Filippo’s <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hZ2UtZW5jcnlwdGlvbi5vcmc=\">age</span> has been  released. It’s a solid design with simple, easily auditable  implementations in Go and Rust. You can build binaries for it for every  mainstream platform. Age is, of course, much younger than PGP. But I  would bet all the money in my pocket against all the money in yours that a new vulnerability will be found in the clangorous contraption of PGP  before one is found in age. Look into age!</p>\n<p>Hopefully it’s clear that this is a pretty narrow use case. We work  in software security and handle sensitive data, including bug bounty  reports (another super common “we need PGP!” use case), and we almost  never have to touch PGP.</p>\n<p>Follow <span class=\"exturl\" data-url=\"aHR0cHM6Ly9taWNyby5ibG9nL2xhdGFjb3Jh\">@latacora on Micro.blog</span>.</p>\n",
            "tags": [
                "隐私"
            ]
        },
        {
            "id": "https://sakurame.eu.org/2023/05/25/privacy/%E9%9A%90%E7%A7%81%E4%BF%9D%E6%8A%A4%E6%8C%87%E5%8D%97%EF%BC%88%E9%95%BF%E6%9C%9F%E7%BF%BB%E8%AF%91%E9%A1%B9%E7%9B%AE%EF%BC%89/",
            "url": "https://sakurame.eu.org/2023/05/25/privacy/%E9%9A%90%E7%A7%81%E4%BF%9D%E6%8A%A4%E6%8C%87%E5%8D%97%EF%BC%88%E9%95%BF%E6%9C%9F%E7%BF%BB%E8%AF%91%E9%A1%B9%E7%9B%AE%EF%BC%89/",
            "title": "隐私保护指南（长期翻译项目）",
            "date_published": "2023-05-25T13:23:39.000Z",
            "content_html": "<h1 id=\"why-privacy-matters\"><a class=\"anchor\" href=\"#why-privacy-matters\">#</a> Why Privacy Matters</h1>\n<p>为什么隐私很重要</p>\n<p>In the modern age of digital data exploitation, your privacy has never  been more critical, and yet many believe it is already a lost cause. It  is not. Your privacy is up for grabs, and you need to care about it. Privacy is about power, and it is so important that this power ends up in the right hands.</p>\n<p>在现在这个数据大爆发的时代，您的隐私从未变得如此危险，并且有很多人相信已经失去了隐私。您的隐私任人宰割，并且需要您去关心它。隐私关乎权利，确保这种权利始终掌握在正确的人手中是如此的重要。</p>\n<p>Privacy is ultimately about human information, and this is important  because we know that human information confers power over human beings.  If we care about our ability to be authentic, fulfilled, and free  humans, we have to care about the rules that apply to information about  us. So much of our modern society is structured around <strong>information</strong>. When you shop online, read the news, look something up, vote, seek  directions, or really anything else, you are relying on information. If  we live in an information society, our information matters, and  therefore privacy matters.</p>\n<p>隐私最终是和人们的基础信息息息相关并且这很重要，因为我们知道人们的信息所赋予人们的权利。我们关心自己成为真实，充实和自由的人的能力，我们就必须关心适用于我们信息的规则，我们现代社会的大部分内容都是围绕<strong>信息</strong>构建的。当您在网上购物、阅读新闻、查找资料、投票、寻找方向或其他任何事情时，您都在依赖信息。   如果我们生活在一个信息社会中，我们的信息很重要，因此隐私很重要。</p>\n<h2 id=\"what-is-privacy\"><a class=\"anchor\" href=\"#what-is-privacy\">#</a> What is Privacy?</h2>\n<p>什么是隐私</p>\n<p>Many people get the concepts of <strong>privacy</strong>, <strong>security</strong>, and <strong>anonymity</strong> confused. You'll see people criticize various products as &quot;not private&quot; when really they mean it doesn't provide anonymity, for example. On  this website, we cover all three of these topics, but it is important  you understand the difference between them, and when each one comes into play.</p>\n<p><strong>许多人混淆了隐私</strong> 、 <strong>安全</strong> 和 <strong>匿名</strong>的概念。例如，您会看到人们批评各种产品 “不私密”，而实际上他们的意思是这些产品不提供匿名功能。   在本网站上，我们涵盖了所有这三个主题，但重要的是您了解它们之间的区别，以及每个主题何时发挥作用。</p>\n<p><strong>Privacy</strong></p>\n<p>隐私</p>\n<p><strong>Privacy is the assurance that your data is only seen by the parties you intend to view it.</strong> In the context of an instant messenger, for example, end-to-end  encryption provides privacy by keeping your message visible only to  yourself and the recipient.</p>\n<p><strong>隐私是保证您的数据只被您期望查看的对方看到</strong>。 例如，在即时通讯程序的上下文中，端到端加密通过使您的消息仅对您自己和收件人可见来提供隐私。</p>\n<p><strong>Security</strong></p>\n<p>安全</p>\n<p>Security is the ability to trust the applications you use—that the  parties involved are who they say they are—and keep those applications  safe. In the context of browsing the web, for example, security can be  provided by HTTPS certificates.</p>\n<p>安全性是信任您所使用的应用程序的能力 —— 正如他们所说的那样 —— 并保证这些应用程序的安全。例如，在浏览 Web 的上下文中，可以通过 HTTPS 证书提供安全性。</p>\n<p>Certificates prove you are talking directly to the website you're  visiting, and keep attackers on your network from reading or modifying  the data sent to or from the website.</p>\n<p>证书证明您正在直接与正在访问的网站对话，并防止您网络上的攻击者读取或修改发送到网站或从网站发送的数据。</p>\n<p><strong>Anonymity</strong></p>\n<p>匿名</p>\n<p>Anonymity is the ability to act without a persistent identifier. You might achieve this online with <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucHJpdmFjeWd1aWRlcy5vcmcvZW4vdG9yLw==\">Tor</span>, which allows you to browse the internet with a random IP address and network connection instead of your own.</p>\n<p>匿名是在没有持久标识符的情况下行动的能力。您可以使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucHJpdmFjeWd1aWRlcy5vcmcvZW4vdG9yLw==\">Tor </span>浏览互联网，它允许您使用随机 IP 地址和网络连接而不是您自己的来来实现这一点。</p>\n<p><strong>Pseudonymity</strong> is a similar concept, but it allows you to have a persistent identifier without it being tied to your real  identity. If everybody knows you as  <code>@GamerGuy12</code>  online, but nobody knows your real name, that is your pseudonym.</p>\n<p><strong>假名</strong> 是一个类似的概念，但它允许您拥有一个持久的标识符，而无需将其与您的真实身份联系起来。如果每个人都知道你是  <code>@GamerGuy12</code>  在线，但没有人知道你的真名，那么它是你的假名。</p>\n",
            "tags": [
                "隐私"
            ]
        }
    ]
}