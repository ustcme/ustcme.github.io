<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="sakura" s="" blog""="" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="sakura" s="" blog""="" type="application/atom+xml"><link rel="alternate" type="application/json" title="sakura&quot;s blog&quot;" href="https://sakurame.eu.org/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/nyx-player-FL6IVJ7K.js"><link rel="modulepreload" href="/js/copy-tex-J4RXVQFU.js"><link rel="modulepreload" href="/js/post-BYOOLMPE.js"><link rel="modulepreload" href="/js/chunk-HOQ6CD2A.js"><link rel="modulepreload" href="/js/tcomments-MXX364JD.js"><link rel="modulepreload" href="/js/chunk-UAU5CDGP.js"><link rel="modulepreload" href="/js/index.esm-D6VTWJFS.js"><link rel="modulepreload" href="/js/chunk-LDEIN6IO.js"><link rel="modulepreload" href="/js/chunk-C2255TGX.js"><link rel="modulepreload" href="/js/cf-patch.js"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media='all'"><script src="/js/cf-patch.js?v=0.5.4" type="module" fetchpriority="high" defer=""></script><link rel="preload" href="https://ptpimg.me/032jxg.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://ptpimg.me/2gyluh.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://ptpimg.me/qnu794.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://ptpimg.me/r129au.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://ptpimg.me/6461y9.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://ptpimg.me/6gf16r.jpg" as="image" fetchpriority="high"><meta name="keywords" content="视频压制技术系列教程"><meta name="description" content="The spirit of independence and the freedom of thought "><link rel="canonical" href="https://sakurame.eu.org/2024/03/16/vcbstudio/%E7%AC%AC%E5%85%AB%E7%AB%A0VS%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80/"><link rel="stylesheet" href="/css/post.css?v=0.5.4"><link rel="stylesheet" href="/css/mermaid.css?v=0.5.4"><!-- 临时处理--><link rel="stylesheet" media="none" onload="this.media='all'" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css"><title>第八章VS视频处理基础</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="pagefind_mount"></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">第八章VS视频处理基础</h1><div class="meta"><span class="item" title="Created: 2024-03-16 23:11:37"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">Posted on</span><time itemprop="dateCreated datePublished" datetime="2024-03-16T23:11:37+08:00">2024-03-16</time></span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i></span><span class="text">Symbols count in article</span><span>19k</span><span class="text">words</span></span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i></span><span class="text">Reading time</span><span>18 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Sakura's Blog</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://ptpimg.me/032jxg.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://ptpimg.me/2gyluh.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://ptpimg.me/qnu794.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://ptpimg.me/r129au.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://ptpimg.me/6461y9.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://ptpimg.me/6gf16r.jpg&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">Home</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/vcbstudio/" itemprop="item" rel="index" title="In视频压制技术"><span itemprop="name">视频压制技术<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" data-pagefind-body="data-pagefind-body" lang="zh-cn"><link itemprop="mainEntityOfPage" href="https://sakurame.eu.org/2024/03/16/vcbstudio/%E7%AC%AC%E5%85%AB%E7%AB%A0VS%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="AUVeggry"><meta itemprop="description" content=", The spirit of independence and the freedom of thought "></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="sakura&quot;s blog&quot;"></span><div class="body md" itemprop="articleBody"><h1 id="第八章-vs视频处理基础"><a class="anchor" href="#第八章-vs视频处理基础">#</a> 第八章 VS视频处理基础</h1>
<p>这一章，我们将会用一些基本工具对画面进行一些简单操作，并且利用他们的组合初步领会预处理的思路。</p>
<h2 id="1-resizer应用"><a class="anchor" href="#1-resizer应用">#</a> 1. Resizer应用</h2>
<p>首先登场的是两位老朋友：<a target="_blank" rel="noopener" href="https://amusementclub.github.io/fmtconv/doc/fmtconv.html"><code>fmtconv</code></a> 和 <a target="_blank" rel="noopener" href="https://amusementclub.github.io/doc/functions/video/resize.html?highlight=resize#resize"><code>zimg</code></a>，复习一下，调用他们分别使用<code>vs.core.fmtc.xxx</code>和<code>vs.core.resize.xxx</code>。</p>
<h3 id="1-平移和裁剪shift-crop"><a class="anchor" href="#1-平移和裁剪shift-crop">#</a> (1). 平移和裁剪（shift &amp; crop）</h3>
<p>此处我们使用到的参数有以下几个：<code>zimg</code>对应的参数是<code>src_left</code>/<code>src_top</code>/<code>src_width</code>/<code>src_height</code>。<code>fmtconv</code>中对应的函数是<code>fmtc.resample</code>，参数分别对应<code>sx</code>/<code>sy</code>/<code>sh</code>/<code>sw</code>。这四个参数表示，输出结果对应着原图中的这样一个长方形区域——它左上顶点坐标是 (src_left,src_top)(src_left,src_top)，宽为 src_widthsrc_width，高为 src_heightsrc_height。如下图所示：</p>
<p>![Sampling Zone](<a target="_blank" rel="noopener" href="https://guides.vcb-s.com/media/basic-guide-08/Figure">https://guides.vcb-s.com/media/basic-guide-08/Figure</a> 1.png)采样区域图示</p>
<p>图中较大的长方形框是原始图像，较小的长方形框——也即<strong>采样区域</strong>，对应结果图像。<br>
所以，如果想将图像向右平移10.5个像素，同时向下平移20个像素——此时我们的小方框顶点应该位于 (−10.5,−20)(−10.5,−20)，所以对应的写法是<code>resize.Spline36(src_left=-10.5, src_top=-20)</code>。同样的，我们还可以使用这个方法进行裁切，比如原图是 1920×10801920×1080，我想上切10像素，下切20像素，那么就是<code>resize.Spline36(src_top=10, src_height=1050)</code>。</p>
<p>那么，假如“小方框”的某一条边落在“大方框”之外（所以前者其实可以比后者大，图中的“大” “小”只是为了便于理解）会怎么样呢？这里两个滤镜的行为出现了差别，超出边缘的像素，<code>zimg</code>会以图像的边缘作为对称轴，镜像补全；而<code>fmtconv</code>会重复边缘的像素来补全。</p>
<h3 id="2-尺寸变换resize"><a class="anchor" href="#2-尺寸变换resize">#</a> (2). 尺寸变换（resize）</h3>
<p>此即图像的放大和缩小，或者说改变采样点（像素）的数量。滤镜依旧是上面所说的两个，<code>zimg</code>使用<code>width</code>/<code>height</code>指定输出图像的尺寸，<code>fmtconv</code>对应的是<code>w</code>/<code>h</code>。该操作将上面提到的<strong>采样区域</strong>（即由<code>src_left</code>/<code>src_top</code>/<code>src_width</code>/<code>src_height</code>指定的）缩放到<code>width</code>x<code>height</code>大小。</p>
<h3 id="3-fmtconv的逐平面处理"><a class="anchor" href="#3-fmtconv的逐平面处理">#</a> (3). <code>fmtconv</code>的逐平面处理</h3>
<p>在使用<code>fmtc.resample</code>时，<code>sx</code>/<code>sy</code>/<code>sh</code>/<code>sw</code>可以传一个数组进去，数组依次指定指定3个平面的参数，例如<code>fmtc.resample(sx=[-1,0,1])</code>。假如数组长度为2，比如<code>sx=[-1,0]</code>，那么第2、3平面共用数组内第二个参数。</p>
<p>除此之外，<code>fmtconv</code>还有<code>planes</code>这个参数，也是传一个数组，具体含义doc里有写：</p>
<blockquote>
<p>This array decribes how each plane should be processed. It’s similar to the y, u and v parameters in Masktools 2.</p>
<ul>
<li>−65535 to +0.5: All the pixels of the plane will be set to −x (the opposite of  the specified value). The range depends on the output data type.  Remember, in floating-point YUV, the chroma planes range from −0.5 to  +0.5.</li>
<li>1:	The plane will not be processed. This means that the content of the output plane is pure garbage.</li>
<li>2: The plane of the input clip will be copied and possibly cropped. Areas  out of the input picture are left unprocessed (garbage). Range (full or  TV) conversions are ignored.</li>
<li>3:	The plane will be processed (default).</li>
</ul>
</blockquote>
<p>所以，假如你发现一个视频有 chroma shift，又不想把平面都拆出来，处理完再拼回去，那么你可以用<code>fmtc.resample(sx=0.3, plane=[2,3,3])</code>来仅仅处理色度平面。</p>
<h3 id="4-matrix转换"><a class="anchor" href="#4-matrix转换">#</a> (4). Matrix转换</h3>
<p>这个其实没啥好说的，<code>fmtconv</code>用<code>fmtc.matrix</code>和<code>fmtc.matrix2020cl</code>，参数的意义在doc里写得都挺明白。<code>zimg</code>则是整合到了各个采样滤镜中，用<code>matrix_in</code>/<code>matrix</code>来指定输入和输出，不过这俩参数只能传数字，更推荐的写法是用<code>_s</code>结尾的参数<code>matrix_in_s</code>/<code>matrix_s</code>传入字符串，看得更加清晰。</p>
<h3 id="5-transfer转换"><a class="anchor" href="#5-transfer转换">#</a> (5). Transfer转换</h3>
<p>除了<code>fmconv</code>用<code>fmtc.transfer</code>之外，用法和上面没啥区别。。。但是有几个需要注意的地方：</p>
<ul>
<li><code>zimg</code>的<code>709</code>实际上是<code>bt1886</code>，和<code>fmtconv.transfer</code>中的<code>1886</code>对应，而不是<code>709</code>。</li>
<li><strong>注意range</strong>，这一点要特别注意，因为<code>fmtconv</code>中默认输入输出都是 <code>full range</code>。于是假如你传进去一个<code>limited range</code> 的Y平面，然后没指定<code>fulls=False</code>，结果就错了。</li>
</ul>
<h3 id="6-gamma-awara-resize"><a class="anchor" href="#6-gamma-awara-resize">#</a> (6). Gamma awara-resize</h3>
<p>下图是一些 Transer的曲线，这里我们从图上直观地理解一下：横轴代表计算机里储存的数，纵轴代表实际的显示亮度，可以很明显地发现：</p>
<ul>
<li>这些曲线都不是线性的（废话）。</li>
<li>他们都是下凹的，也就是说暗场给了更多的数字来表示。</li>
</ul>
<p>![img](<a target="_blank" rel="noopener" href="https://guides.vcb-s.com/media/basic-guide-08/Figure">https://guides.vcb-s.com/media/basic-guide-08/Figure</a> 2.jpeg)</p>
<p>那么我们想象一下，假如说我们在用双线性算法缩小图像的时候，在 <code>full range 8bit</code>下，有两个像素：0和255，那么在他们中点插值的像素值将会是128，我们姑且认为我们将这两个像素合并成了一个，那么按理说，视觉上应该是得到中性灰。但是由于 transfer 曲线将0-255中更多的数字给了暗场，所以得到的 128 会比中性灰更暗。其他的 kernel  大同小异。这么做的后果是图像的对比度会下降，比如这张图：</p>
<p>![img](<a target="_blank" rel="noopener" href="https://guides.vcb-s.com/media/basic-guide-08/Figure">https://guides.vcb-s.com/media/basic-guide-08/Figure</a> 3.png)</p>
<p>直接缩到1/4大小，会得到：</p>
<p>![img](<a target="_blank" rel="noopener" href="https://guides.vcb-s.com/media/basic-guide-08/Figure">https://guides.vcb-s.com/media/basic-guide-08/Figure</a> 4.png)</p>
<p>可以明显感觉灯光的对比度低了。诚然，resizer自带的low-pass效应是一点，tranfer压缩是另一点。</p>
<p>那么怎么办呢？我们可以将图像转到线性光下，再做resize，然后转回transfer压缩的效果。还是那张图，如果在线性光下做：</p>
<p>![img](<a target="_blank" rel="noopener" href="https://guides.vcb-s.com/media/basic-guide-08/Figure">https://guides.vcb-s.com/media/basic-guide-08/Figure</a> 5.png)</p>
<p>vs中，可以这样写：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> colorfamily</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">transfer</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">transs</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">709</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> transd</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">linear</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulls</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulld</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1280</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">720</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">transfer</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">transs</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">linear</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> transd</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">709</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">fulls</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulld</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">UV</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src16</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1280</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">720</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">down </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#A65E2B;--shiki-dark:#C99076">UV</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">YUV</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>我们来一句句看：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> colorfamily</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">transfer</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">transs</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">709</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> transd</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">linear</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulls</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulld</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>这是把源的Y平面拿出来，再丢给fmtc.transfer，从709的transfer压缩，转为线性光。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1280</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">720</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> gray</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">transfer</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">transs</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">linear</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> transd</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">709</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">fulls</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> fulld</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>在线性光下做好缩放后，再转回带transfer压缩的效果。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">UV</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src16</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1280</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">720</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">down </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">gray</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#A65E2B;--shiki-dark:#C99076">UV</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">YUV</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>正常缩放UV，跟处理后的Y平面混合。</p>
<p>实际上709的tansfer压缩是在RGB下做的，受到YCbCr矩阵影响，chroma上其实还是有部分Luma信息  ，只用Y'做转换不太准确。你可以看到UV计算，是基于transfer压缩后的RGB。如果RGB本身是未压缩的线性光，UV的值会有改变；虽然YUV的机制保证了它改变的不大。理想的YUV机制，应该完全消除掉亮度在UV平面的影响，也就是对亮度进行统一的变换。UV的值不应该改变（注意它是亮度做差）。这是理想中情况，现实中很难做到。</p>
<h3 id="7-chroma-subsample-与-chroma-placement"><a class="anchor" href="#7-chroma-subsample-与-chroma-placement">#</a> (7). Chroma subsample 与 Chroma placement</h3>
<p>前文提到过，YUV空间下的色度平面中心可能会出现和亮度平面不一致的情况（Chroma subsample），利用resizer可以对这些不同的采样进行转换。如果是无脑调用滤镜的话，<code>zimg</code>用<code>format</code>参数指定输出的格式（同时也就指定了色度采样类型），<code>fmtconv</code>则使用<code>css</code>单独表示输出的色度采样类型。即使有这些看上去很方便的工具，但我们还是要打开黑匣子——如果给你一个YUV420的视频，让你手动放大UV，转成YUV444，你要怎么操作？</p>
<p>上文所提到的两个resizer，默认是中心对齐的放大，例如：</p>
<p>原本的3个像素采样位置是 [2,4,6][2,4,6]，中点为4；放大后采样位置变成了 [1,2,3,4,5,6,7][1,2,3,4,5,6,7]，中点还是4。</p>
<p>如果YUV420是MPEG1的cplace。那么你直接可以将UV放大到两倍：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">xxx.jpg</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8 </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">lsmas</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">LWLibavSource</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">U </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resize</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Lanczos2</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">width</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">height</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">V </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resize</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Lanczos2</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">width</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">height</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">res </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> U</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> V</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">YUV</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">res</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">set_output</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>那么如果是MPEG2的cplace呢？Y和UV是左端对齐：</p>
<p>Y的采样位置—— [1,2,3,4,5,6][1,2,3,4,5,6]，中点是3.5；</p>
<p>UV的采样位置—— [1,3,5][1,3,5]，中点是3。 此时，如果我们还是按照中心对齐，将UV放大到2x，那么UV的采样位置变成了 [0.5,1.5,2.5,3.5,4.5,5.5][0.5,1.5,2.5,3.5,4.5,5.5]（中点还是3）。 那么该怎么办呢？</p>
<p>来看下面这张图：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/YUV_420_chroma_place_MPEG-2-e32ce4d576f99e56549c00b28389bf20.png" alt="Figure 5"></p>
<p>所有黑点，是Y的采样位置；蓝色的点，是MPEG2下，UV的采样位置；红色的是MPEG1下的位置；我们希望调整到红色。那么就需要把UV，向右移动Y的尺度下的0.5像素，这0.5像素就是红点和蓝点之间的距离；那么在UV的尺度下，这0.5就变成了0.25。所以如果是MPEG2的cplace，在resize的时候：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">xxx.jpg</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8 </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">lsmas</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">LWLibavSource</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">U </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resize</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Lanczos</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">width</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">height</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> src_left</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.25</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">V </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">GRAY</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resize</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Lanczos</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">width</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Y</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">height</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> src_left</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.25</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">res </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> U</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> V</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">YUV</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">res</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">set_output</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    </span></span></code></pre>
<p>与此类似地，我们不仅可以把UV拉上来，还可以把Y降下去：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src16</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">width</span><span style="color:#AB5959;--shiki-dark:#CB7676">/</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#999999;--shiki-dark:#666666"> ,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src16</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">height</span><span style="color:#AB5959;--shiki-dark:#CB7676">/</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> sx</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.5</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">down </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">ShufflePlanes</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Y</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> vs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#A65E2B;--shiki-dark:#C99076">YUV</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>上面这两行，如果活用<code>fmtconv</code>的话可以变成一行：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>down = core.fmtc.resample(src16, 960, 540, sx=-0.5, planes=[3,2,2], css="444")</span></span></code></pre>
<p>以上就是Chroma subplace转换的基本方法，计算平移参数的技巧以后还会反复使用。</p>
<h2 id="2-blurring"><a class="anchor" href="#2-blurring">#</a> 2. Blurring</h2>
<h3 id="1-removegrain"><a class="anchor" href="#1-removegrain">#</a> (1). RemoveGrain</h3>
<p>Blurring，意为模糊，这里介绍一个新的基础滤镜——<code>RemoveGrain</code>，调用它的方式是<code>vs.core.rgvs.RemoveGrain()</code>，他是avs的<code>RgTools</code>在vs中的移植，可以在<a target="_blank" rel="noopener" href="http://avisynth.nl/index.php/RgTools">这里</a>找到他和其他同样在<code>RgTools</code>里的滤镜doc。下面来讲讲模糊的基本方法。</p>
<h4 id="平均值模糊average-blur"><a class="anchor" href="#平均值模糊average-blur">#</a> 平均值模糊（Average Blur）</h4>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Noise_graph-cb8998cb565c1afd7e6093c3699e06d4.png" alt="Figure 6"></p>
<p>上面这些起起伏伏可以看作是噪点，所谓降噪，就是要把它抹平，那么最简单的，把所有点的值做个平均填回去：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Average_deblur-45d1aaf28b8b9fa801a4bc58e45fd70a.png" alt="Figure 7"></p>
<p>好，非常平,马赛克大概就是这么做的，把某一区域所有像素的值取个平均。我们在vs中也可以做类似的事情，<code>core.rgvs.RemoveGrain(src, 20)</code>。它做的是：把某个像素取值变成 它和周围8个像素的平均值，这里一共有9个像素参与了计算。比如极端一点的情况，某个像素是10，周围8个像素是1，那么经过<code>RemoveGrain(20)之后，这个像素就变成了2</code>。</p>
<p>这种操作太糊了，我们想要一个稍微弱一点的模糊。最简单的想法：我把中间那个像素的权重提高一点，这就是<code>RemoveGrain(11)</code>。具体权重的取值是：</p>
<p>[1161811618141811618116]⎣</p>
<p>⎡1618116181418116181161⎦</p>
<p>⎤</p>
<p>就是说中间的像素乘以1/4、加上中心十字的四个像素乘以1/8、加上四个角的四个像素乘以1/16。 把权重加起来是1，说明这是个unbiased的操作。可以用vs试试<code>RemoveGrain(11)</code>，看看是不是要比20清晰一点。类似的还有:<code>RemoveGrain(19)</code>： 权重是：</p>
<p>[18181818018181818]⎣</p>
<p>⎡81818181081818181⎦</p>
<p>⎤</p>
<p>可以想见这个会比20还要糊。 以上三种，叫Average Blur，用平均值进行模糊。既然可以用平均值，我们不难想到另一个经常和平均值一起出现的中位数。</p>
<h4 id="中位数模糊median-blur"><a class="anchor" href="#中位数模糊median-blur">#</a> 中位数模糊（Median Blur）</h4>
<p>中位数，同样的，我们可以取一个像素和周围八个像素总计9个像素的中位数。这就是RemoveGrain(4)。另外还有三个采用这种思路的模糊滤镜，分别是1，2，3。首先我们把周围8个像素的值排序，我们把mode的值叫做a，要是中间像素的值在排序中，比第a大的值还要大，就把它换成这个第a大的值；如果比第a小的值还要小，就把他换成这个第a小的值。 比如：</p>
<p>[593726148]⎣</p>
<p>⎡571924368⎦</p>
<p>⎤</p>
<p>然后我们的mode设置为1，2并不比1小也不比9大，什么都不会发生。mode为2，2正好是第2小的，什么都不会发生。mode为3，2终于比3要小了，所以中间2会变成3。变成：</p>
<p>[593736148]⎣</p>
<p>⎡571934368⎦</p>
<p>⎤</p>
<p>同理，那么<code>mode</code>为4，2就会变成5。然后不难证明，假如<code>mode</code>是4，中间那个像素永远会变成中央加周边总共9个像素的中位数。从刚才这个流程里我们可以看到，随着<code>mode</code>从1到4，原来在9个像素里面比较小的2逐渐变大了，也就是说模糊的效果逐渐加强了。</p>
<p>然后，<code>RemoveGran</code>的<code>mode</code>参数是可以接受数组的，最多不超过<code>src</code>的平面数目，假如不足<code>src</code>的平面数目的话，那么滤镜会自动把<code>mode</code>扩展成一个长度为3的数组。例如<code>src</code>有三个平面，<code>mode</code>是1，那么滤镜会自动把<code>mode</code>扩展成一个长度为3的数组<code>[1,1,1]</code>，假如<code>mode</code>是<code>[20, 1]</code>那么滤镜会会把它变成<code>[20,1,1]</code>，总而言之就是重复的是数组最后一个数。这三个数对应着<code>RemoveGrain</code>会用什么样的<code>mode</code>去对<code>src</code>的三个平面做模糊。例如<code>[20, 1, 1]</code>，就意味着对Y平面用20，对UV平面用1。</p>
<h4 id="中值模糊-vs-中位数模糊"><a class="anchor" href="#中值模糊-vs-中位数模糊">#</a> 中值模糊 vs 中位数模糊</h4>
<p>Average Blur &amp; Median Blur 这两大类的滤镜的适用范围不太一样。比如下面这个极端情况：</p>
<p>[00001000000]⎣</p>
<p>⎡00001000000⎦</p>
<p>⎤</p>
<p>用 RG4 会把中间的100直接变成0；用 RG20 则会把中间变成11。</p>
<p>再比如这里有一根线：</p>
<p>[010001000100]⎣</p>
<p>⎡000101010000⎦</p>
<p>⎤</p>
<p>假如用 RG4 的话，中间会变成0，表现为特别细的线会直接被抹掉，这也就是中位数模糊不太适用的场景。</p>
<p>还有一种很特殊的噪声，称为椒盐噪声，像这样 <s>撒盐图中差可拟</s>：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Salt-and-pepper_noise-bf6c8d834f8743b7b5659a941df44b66.jpg" alt="Figure 8"></p>
<p>RG4会直接把它抹平，RG20还会残留一点。而这种情况下我们一般倾向于抹平，所以中位数模糊是很合适的：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Median_blur_for_Salt-and-pepper_noise-d8472f472072d0ed03d6e97fb6748790.jpg" alt="Figure 9"></p>
<p>假如用平均值模糊的话，会变成这样：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Average_blur_for_Salt-and-pepper_noise-ad2d28811f2ea73ca246d70b1a04823d.jpg" alt="Figure 10"></p>
<p>比较丑陋。</p>
<p>但就像刚才提到，在普通的图像中中位数模糊对于画面的破坏是比较大的，因此总的还是突出一个综合考虑。然后<a target="_blank" rel="noopener" href="https://github.com/HomeOfVapourSynthEvolution/havsfunc"><code>havsfunc</code></a>里面，就有这么一个综合考虑的滤镜，<code>MinBlur</code>，会选取两种方式中破坏较小的那种，并跟上一些后处理，具体可以看其中的代码。</p>
<h4 id="自定义平均权重"><a class="anchor" href="#自定义平均权重">#</a> 自定义平均权重</h4>
<p>对于以上提到的平均值模糊，对图像处理熟悉的同学会发现其实就是用一个 3×33×3 的核（kernel）进行卷积，如果我们想自己设定权重该怎么办呢？可以用<a target="_blank" rel="noopener" href="https://amusementclub.github.io/doc/functions/video/convolution.html?highlight=conv#std.Convolution"><code>vs.core.std.Convolution()</code></a>，用<code>matrix</code>参数传入卷积核，会比<code>rgvs</code>快一些。</p>
<h3 id="2-usmunsharp-mask"><a class="anchor" href="#2-usmunsharp-mask">#</a> (2). USM（Unsharp Mask）</h3>
<h4 id="clip的简单运算"><a class="anchor" href="#clip的简单运算">#</a> clip的简单运算</h4>
<p>我们可以对两个clip进行一些简单的运算：拥有相同帧序号的相同平面之间，进行逐像素的运算——这自然要求两个clip之间的格式和分辨率要是相同的。这里举一些滤镜来实现：</p>
<h5 id="vscorestdmergeclipa-clipb-weight"><a class="anchor" href="#vscorestdmergeclipa-clipb-weight">#</a> <a target="_blank" rel="noopener" href="https://amusementclub.github.io/doc/functions/video/merge.html?"><code>vs.core.std.Merge(clipa, clipb, weight)</code></a>：</h5>
<p>这里表示对<code>clipa</code>和<code>clipb</code>进行线性的融合，结果可以表示成 (1−weight)×clipa+weight×clipb(1−weight)×clipa+weight×clipb 。比如<code>weight=0</code>时，结果就是<code>clipa</code>；<code>weight=1</code>时，结果就是<code>clipb</code>；</p>
<h5 id="vscorestdmakediffclipa-clipb"><a class="anchor" href="#vscorestdmakediffclipa-clipb">#</a> <a target="_blank" rel="noopener" href="https://amusementclub.github.io/doc/functions/video/makediff.html"><code>vs.core.std.MakeDiff(clipa, clipb)</code></a>以及<a target="_blank" rel="noopener" href="https://amusementclub.github.io/doc/functions/video/mergediff.html"><code>vs.core.std.Mergediff(clipa, clipb)</code></a>：</h5>
<p>这两个滤镜分别表示 clipa−clipbclipa−clipb和 clipa+clipbclipa+clipb，注意，和<code>std.Merge()</code>不同，这里相加减可能会超出整数的范围。所以假如你传入的是整数类型的clip，做减法的时候<code>std.MakeDiff()</code>会加上一个中点的偏置，比如8bit视频会加上128；做加法的时候<code>std.MergeDiff()</code>会减去一个中点的偏置，比如8bit视频会减去128。当然这并不能完全解决超出范围的问题，不过好在我们直接做差的视频一般是比较相似的，所以一般没事，如果你实在不放心，可以转成浮点再做。</p>
<h4 id="分离噪点层"><a class="anchor" href="#分离噪点层">#</a> 分离噪点层</h4>
<p>会对clip进行简单的运算后，我们来进行一组操作：首先对 src 进行一个 RG11 ,可以想见，结果比较糊、噪点比较少，就叫 blur；然后用<code>MakeDiff</code>做 src−blursrc−blur ，就得到了噪点层—— blur 和 src 的差异。</p>
<h4 id="unsharp-mask"><a class="anchor" href="#unsharp-mask">#</a> Unsharp Mask</h4>
<p>然后，我们将这个噪点层——它包含了原图比较多的高频信息，用<code>MergeDiff</code>加到 src 上，这就是最简单且副作用爆炸的锐化：Unsharp  Mask。这玩意儿的副作用包括但不限于：ringing，aliasing，爆炸的噪点。这玩意儿就是photoshop的usm。但也是有好处的，黑色的线条看起来更黑了，纹理更清晰了，这也是我们后续所有锐化手段的基础。我们需要对它做各种限制，希望尽量保留下它的锐化效果又能消除多余的ringing之类的东西。</p>
<h3 id="3-sbr"><a class="anchor" href="#3-sbr">#</a> (3). SBR</h3>
<p>现在手上有一张重噪点的图：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Heavy_noise_flower-2e5630207c969f9b1cb1151185d57945.jpg" alt="Figure 11"></p>
<p>画面中还有一朵看起来比较清晰的花，现在我们对它RemoveGrain，得到blur：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Removegrain_flower-f16ec869bc441f1ba31cf3a584e7c3f4.jpg" alt="Figure 12"></p>
<p>噪点看起来平滑了很多，但是花也被搞糊掉了，我们用这两张图做一个usm：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Usm-800f8aafd5017794bfd7ce2783f7e489.jpg" alt="Figure 13"></p>
<p>出了这么个东西，可以看到，原来花的那个位置有个比较明显的轮廓，然后整体看起来有噪点，那么我们对这个clip做一个RemoveGrain：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Removegrain_usm-e64e92df16e924d1cf9e55bc1cca8f7e.jpg" alt="Figure 14"></p>
<p>看起来噪点减少了，但花的轮廓还在，我们把这个clip加回到之前的blur，最后得到的是这样一张图:</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/Limited_blur-968e2680b556b314455262d80639bd5a.jpg" alt="Figure 15"></p>
<p>可以看到整体的模糊效果减小了，这就是最基础的限制blur滤镜强度的一个方法。然后因为是限制blur滤镜的，实际上也意味着在用usm做锐化的时候，我们也可以限制锐化的强度了。</p>
<h2 id="3-repair"><a class="anchor" href="#3-repair">#</a> 3. Repair</h2>
<p>这一节要引进一个新的滤镜——<a target="_blank" rel="noopener" href="http://avisynth.nl/index.php/RgTools/Repair"><code>vs.core.rgvs.Repair(clip, ref, mode)</code></a>， 我们一般用 mode 1~4——mode N 表示，clip 的某个像素，倘若超出 ref 对应像素及其周围8个像素中 [[第NN小,,第NN大]]，这个范围，那么就取 ref中，这九个像素的 第N小/第N大。这个感觉和<code>RemoveGrain</code>有点像——RG做的是：每一个像素，相比于自己周边8个像素，不要太过分；<code>Repair</code>做的是，clip 的每一个像素，相比于 ref 的9个像素，不要太过分。这种操作经常用于可能引入突兀瑕疵的 clip。</p>
<h3 id="1-deringing"><a class="anchor" href="#1-deringing">#</a> (1). Deringing</h3>
<p>知道了 Repair 有这个功能，我们就来看看它为啥可以做 de-ringing。</p>
<p>一条 2px 宽度的黑色线条，如果周边都是灰色的像素。那么扁平化了看，像素的值是：</p>
<p>[128,128,128,16,16,128,128][128,128,128,16,16,128,128]</p>
<p>中间两个16是黑色，周边是128的灰色。ringing发生的时候，会变成这样：</p>
<p>[128,128,160,16,16,160,128][128,128,160,16,16,160,128]</p>
<p>直观的看就是裹着线条的像素值变得更剧烈了。Repair做的，就是看 clip 的每个像素，是不是值偏高或者偏低，比如 160，对应源周边的像素，要么是128要么是16，显然已经高了，就把它限制为最高值，如果不超过范围就不处理，跟RemoveGrain一样。</p>
<h3 id="2-non-ringing-upscale"><a class="anchor" href="#2-non-ringing-upscale">#</a> (2). Non-ringing upscale</h3>
<p>non-ringing 的做法，就是取一个 sharp 的作为 clip ，取一个没有ringing，soft的作为 ref ，然后做一个repair：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">sharp </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">down</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1920</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1080</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> kernel</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">lanczos</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> a1</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">4</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">soft </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">fmtc</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">resample</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">down</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1920</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1080</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> kernel</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">gauss</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> a1</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">90</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">up </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rgvs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Repair</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">sharp</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> soft</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>有读者可能会担心，这么做，会不会让 Lanczos 本身锐利的一面被削弱，实际观感更接近 soft 的 Gaussian。这点大家可以试试，实际用起来，取<code>a1=90</code>左右，观感是最平衡的。</p>
<h3 id="3-rg-dering"><a class="anchor" href="#3-rg-dering">#</a> (3). RG Dering</h3>
<p>resize 的时候可以这样 de-ringing，平时呢？ 拿到一个有ringing的源，也只要制造一个soft，然后<code>Repair(src, soft)</code>就行。 这就是RG Dering:</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">soft </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> RemoveGrain</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#999999;--shiki-dark:#666666"> </span><span style="color:#1e754f;--shiki-dark:#4d9375">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">20</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 11</span><span style="color:#1e754f;--shiki-dark:#4d9375">]</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Repair</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> soft</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<h3 id="4-利用repair-限制usm"><a class="anchor" href="#4-利用repair-限制usm">#</a> (4). 利用Repair 限制USM：</h3>
<p>USM，这东西还有个意想不到的用途：就是编码前用个什么 RG11 这种light-kernel给锐化一下，压出来的成品，vmaf分会高的离谱。也是好事吧，毕竟人眼非常喜欢  usm。最后，千万别对老番烂番直接用。。。因为 USM 会把烂在哪里放大了给你看：它会把很多瑕疵放大，让锯齿、ringing、blocking  显露得非常明显。</p>
<p>怎么限制它的副效果呢？一个方法就是用Repair，Repair(sharp, src)。这就是ModerateSharpening。</p>
<p>ModerateSharpening会把ringing去掉很多，但是留下的锯齿很明显。所以实际生产也没人用。。。non-the-less这是一个Repair的好用法。</p>
<h3 id="5-contra-sharpen"><a class="anchor" href="#5-contra-sharpen">#</a> (5). Contra-Sharpen</h3>
<p>Contra-Sharpen一般是，做了一些带有blurring性质的操作后，比如抗锯齿，比如降噪，画面看起来变模糊了。我们想对画面做一个锐化，补偿一下锐度损失，但是又不希望这个锐化使得画面看上去比源更锐利。如果源是 src，你一番处理后成了 flt，比如做了个高质量降噪。可能多数场景，flt 锐利度比源下降了 5%，少数场景下降了  20%。（比划一下，具体怎么量化我也不知道。。。）你如果一波USM，雨露均沾的，把锐利度提升了15%。少数场景的确几乎回到了之前的水准，但是多数场景就比之前还锐利，咋办？我们希望限制一下，锐利度提升，不要超过 flt 比起 src 下降的尺度。也就是，锐化时候，打上去的 diff，不要比 src−fltsrc−flt还过分。即：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">blur </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> RG</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">flt</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 20</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff_for_sharp </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> flt </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> blur</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff_src_flt </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> flt</span></span></code></pre>
<p>然后我们希望，对于每个像素确保： ∣flt−blur∣&lt;=∣src−flt∣∣flt−blur∣&lt;=∣src−flt∣</p>
<p>然后： sharp=flt+(flt−blur)sharp=flt+(flt−blur)</p>
<p>这个思路原原本本实现，需要借助Expr做像素级计算，但是用Repair可以近似实现： ∣flt−blur∣&lt;=∣src−flt∣(max of 3∗3)∣flt−blur∣&lt;=∣src−flt∣(max of 3∗3)</p>
<p>这就是 contra-sharp的思路 。我们结合代码来看：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16 </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">bilateral</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Bilateral</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> sigmaS</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1.5</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">sigmaR</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.015</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> algorithm</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">noise </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MakeDiff</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">blur </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rgvs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">RemoveGrain</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 11</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MakeDiff</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">blur</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rgvs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Repair</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">noise</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">res </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MergeDiff</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p><code>nr16 = core.bilateral.Bilateral(src16, sigmaS=1.5,sigmaR=0.015, algorithm=2)</code> 这是调用Bilateral算法（当年avs没有好的降噪滤镜用，这是一个还行的工具了）进行高质量降噪；</p>
<p><code>noise = core.std.MakeDiff(src16,nr16)</code> 这是分离噪点，也就是 src−fltsrc−flt；</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">blur </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rgvs</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">RemoveGrain</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 11</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">std</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">MakeDiff</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nr16</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">blur</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<ol>
<li>这是获取锐化用的diff；</li>
<li><code>diff = core.rgvs.Repair(diff,noise,1)</code> 这就是确保，锐化用的diff，每个像素的改动，不要超过(源-锐化)对应位置9个像素的最大改动。近似的可以认为是对应像素位置，降噪而损失的锐利度；</li>
<li>最后，<code>res = core.std.MergeDiff(nr16,diff)</code>。把限制过的diff层加回去，完成锐化。</li>
</ol>
<p>这个实现方式并非严格的保证锐化程度不超过源，而是用了一个近似，允许一定程度放大锐化强度。原则上锐化强度不该超过像素自身损失，现在是允许不超过周边3x3像素的损失，即 locally restricted 而非 pixel-wise  restricted。所以这东西说是补偿，其实还是略微在源的基础上放大了一些锐利度，因为早期TAA（常用的抗锯齿）滤镜最后就给你来这一手，所以经常给人以“抗锯齿会让线条变得更锐利”的错觉。</p>
<h2 id="4-limitfilter"><a class="anchor" href="#4-limitfilter">#</a> 4. LimitFilter</h2>
<p>上一节提到，Repair根据周边像素的相对大小来限制 ref 和 src 的区别不能过大。LimitFilter则是比较像素本体数值，跟一个阈（yù）值，以及允许的弹性程度作比较。最早来自于avs的dither package，现在则是一般用<code>mvf.LimitFilter</code>。用法<code>mvf.LimitFilter(flt, src, thr, elast)</code>。其中， <code>flt</code> 是要处理的clip；<code>src</code>是原始的clip；<code>thr</code>是一个阈值，表示8bit下，flt 和 src 可以差别多大。通常取值在0.5~3.0左右，表示8bit下允许偏移这么多。小数不用担心，内部运算精度是16bit的；<code>elast</code>，是弹性值，我们随后说。</p>
<p>这里举个简单例子来说明它的作用表现，假设src的某个像素是50,<code>thr=0.5, elast=2.0</code>:</p>
<ol>
<li>∣flt−src∣&lt;=thr∣flt−src∣&lt;=thr，直接保留。比如说 flt=49.8 或者 50.4，那么不做调整；</li>
<li>∣flt−src∣&gt;thr×elast∣flt−src∣&gt;thr×elast，直接取值 src。比如说 flt=48.9 或者 51.7，那么直接设置为 50；</li>
<li>thr&lt;∣flt−src∣&lt;thr×elastthr&lt;∣flt−src∣&lt;thr×elast ， 结果会被连续地调整到 [src−thr×elast24×(elast−1),src+thr×elast24×(elast−1)][src−thr×4×(elast−1)elast2,src+thr×4×(elast−1)elast2] 之间: final=src+(flt−src)×thr×elast−∣flt−src∣thr×elast−thrfinal=src+(flt−src)×thr×elast−thrthr×elast−∣flt−src∣。</li>
</ol>
<p>比如 flt=49.1，调整结果大约为 49.8；flt=50.6，调整结果大约为 50.5。</p>
<p>综合以上，在<code>thr=0.5, elast=2.0</code>时，我们可以画出这个图：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/LimitFilter_0.5_2-945f8a18041ac8e274335a308bf4a78e.png" alt="Figure 16"></p>
<p>可以看到在<code>thr=0.5, elast=2.0</code>下。滤镜保证 ∣final−src∣&lt;=0.5∣final−src∣&lt;=0.5。</p>
<p>elast&lt;=2elast&lt;=2 的时候，有个很巧的结论，就是 ∣final−src∣&lt;=thr∣final−src∣&lt;=thr。如果调整后出现 ∣final−src∣&gt;thr∣final−src∣&gt;thr，则一定是 elast&gt;2elast&gt;2 才会出现。（你可以通过一些简单的计算证明这个结论）</p>
<p>这里再贴上一些不同参数下的曲线以供比较：</p>
<p><img loading="lazy" src="https://guides.vcb-s.com/assets/images/LimitFilter_Combined-6fe4588ee81433a7fdac6001d6521194.png" alt="Figure 17"></p>
<p>除此之外，LimitFilter还有一些例如<code>ref</code>的参数，因为一般用不到且原理大差不差，就不交代了，下面给出<code>mvf.LimitFilter</code>的完整计算过程。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>## Algorithm for Y/R/G/B plane (for chroma, replace "thr" and "brighten_thr" with "thrc")</span></span>
<span class="line"><span>##     dif = flt - src</span></span>
<span class="line"><span>##     dif_ref = flt - ref</span></span>
<span class="line"><span>##     dif_abs = abs(dif_ref)</span></span>
<span class="line"><span>##     thr_1 = brighten_thr if (dif &gt; 0) else thr</span></span>
<span class="line"><span>##     thr_2 = thr_1 * elast</span></span>
<span class="line"><span>##</span></span>
<span class="line"><span>##     if dif_abs &lt;= thr_1:</span></span>
<span class="line"><span>##         final = flt</span></span>
<span class="line"><span>##     elif dif_abs &gt;= thr_2:</span></span>
<span class="line"><span>##         final = src</span></span>
<span class="line"><span>##     else:</span></span>
<span class="line"><span>##         final = src + dif * (thr_2 - dif_abs) / (thr_2 - thr_1)</span></span></code></pre>
<h3 id="1-limitfilter-与-usm"><a class="anchor" href="#1-limitfilter-与-usm">#</a> (1). LimitFilter 与 USM</h3>
<p>第一个用途，我们可以用LimitFilter来限制USM的副效果，例如<code>LimitFilter(thr=3.0, elast=4.0)</code>。上节提到了 ModerateSharpening——<code>Repair(usm, src, 1)</code>。事实上用 LimitFilter  效果更好，可以选择控制的参数也更多。不只是处理锐化，AA、dering，以及很多破坏性处理，它都能处理得很好。Repair 一个缺点是只能处理  flt 比 src 更“突兀”的，而LimitFilter两个方向都能处理。你既可以用它来限制类似 blurring、debanding 这类  smooth 滤镜的破坏力，也可以用它来限制 sharpening，line-darkening 这种 enhance 滤镜的副效果。</p>
<h3 id="2-limitfilter-与-deband"><a class="anchor" href="#2-limitfilter-与-deband">#</a> (2). LimitFilter 与 Deband</h3>
<p>Dither Package当年引入这个东西，主要是为了做 Deband（去色带） 的。它是一个叫做 GradFun3  滤镜的组成部分。它们处理色带的方法是：用一个强力的，大范围的，高精度的smooth滤镜先轰一遍，把色带轰平了，然后用 LimitFilter  抢救细节。因为色带所处的平面，轰一下改变很小，很可能在给定的 thr 之内；但是线条、纹理等细节，轰一下改变就很高了，可以用  LimitFilter 来还原成 src 或者接近 src 的数值，这是当年一种做 deband 的方法。</p>
<p>另一种，是基于上古滤镜，flash3k_yuv_deband（f3kdb）。f3kdb 没这么多花花肠子，就是找得准，然后轰。有关 Deband 的内容后续会有专门的章节，这里我们仅仅拿出一套参数来充当展示。</p>
<p><code>dbed = core.neo_f3kdb.Deband(src,8,48,48,48,0,0,output_depth=16)</code>这是一个使用f3kdb，进行Deband的例子，具体参数的设置和含义先按下不表，我们先认为这个操作去掉了banding（色带）</p>
<p>此时 f3kdb 可以看做一个精准的smoothing kernel，图像经过这么一整变得更加平滑，我们把它跟LimitFilter结合起来</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">dbed </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> core</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">neo_f3kdb</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Deband</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">8</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">48</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">48</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">48</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">output_depth</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">16</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">dbed </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> mvf</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">LimitFilter</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">dbed</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pre_db</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">thr</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.5</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">thrc</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0.6</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A">elast</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1.5</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>注意这里<code>thrc=0.6</code>，是chroma平面的thr。一般 Deband 的 thr×elastthr×elast 不超过2，因为大多数色带就只是1级别的差距，不会很大。而如果像 USM 那样，目的是限制线条， thr×elastthr×elast 就会给的很高，比如 3 x 4=12。</p>
<h3 id="3-limitfilter-融合线条与非线条"><a class="anchor" href="#3-limitfilter-融合线条与非线条">#</a> (3). LimitFilter 融合线条与非线条</h3>
<p>这个需求最早是avs时代，mawen1250 写 nnedi3_resize16 的。天才mawen1250，早在 madVR 用 nnedi3  拉升之前，就设想出可以用nnedi3，这个本职为倍高的滤镜，做一个高质量的upscaler。问题是，nnedi3当时运算精度为8bit，8bit的精度处理线条部分没问题，处理平面部分就很恶心了。低精度的resize很容易在平面引入肉眼可见的色带，咋办？两条路：</p>
<ol>
<li>用8bit精度处理完后接一个deband；这样可行，但是，deband本身是个很复杂的操作，参数不太好给；</li>
<li>线条部分用8bit，平面部分用16bit的常规resizer（avs时代已经有Dither_resize16做高精度resize）。反正平面部分拉升，算法好不好都没有啥区别。然后，根据线条框一个mask（区分线条平面），线条部分采取8bit高质量拉升，平面部分采取16bit高精度拉升。</li>
</ol>
<p>后者是旧版nnedi3_resize16的做法。这个做法是没问题的，效果也很好，就是。。。慢。最后，mawen想到了一招：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">edge </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> nnedi3</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src8</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">to_16_bit</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">nonedge </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> resize16</span><span style="color:#2993a3;--shiki-dark:#5eaab5">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src16</span><span style="color:#2993a3;--shiki-dark:#5eaab5">)</span></span></code></pre>
<p>这两个clip，平面部分虽然精度有差别，但是差别非常小，也就是数值1左右的范围.如果两个clip差别在1.0以内，我认定这块是nonedge；如果差别在1.5以上，我认定这是edge。区别在这中间，不要紧，只要保证过渡连续性就好。这完全可以用LimitFilter实现：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-text"><span class="line"><span>LimitFilter(nonedge, edge, thr=1.0, elast=1.5)</span></span></code></pre>
<p>用了这个方案后性能提升非常多。到了vs时代，滤镜内部精度都上浮点数了，这个 trick 自然没有再用的必要。但是这是在masktools之前，一个很有用的，对线条，对平面分别处理，然后巧妙的融合两者的做法：</p>
<p><code>LimitFilter(nonedge, edge, thr=1.0~2.0, elast=1.5~2.0)</code>。</p>
<p>事实上，deband本身可以看做，对平面做 deband（nonedge=dbed），对线条不做处理（edge=src）：<code>LimitFilter(dbed, src, thr=1.0, elast=1.5)</code>。</p>
<div class="tags"><a href="/tags/%E8%A7%86%E9%A2%91%E5%8E%8B%E5%88%B6%E6%8A%80%E6%9C%AF%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/" rel="tag"><i class="ic i-tag"></i>视频压制技术系列教程</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-eye"></i></span><span class="text">Total Views: </span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/2024/03/16/vcbstudio/第八章VS视频处理基础/">Loading...</span></span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">Edited on </span><time title="Modified: 2024-03-16 23:12:19" itemprop="dateModified" datetime="2024-03-16T23:12:19+08:00">2024-03-16</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" src="/assets/monero.avif" alt="AUVeggry monero"><p>monero</p></div><div><img loading="lazy" src="/assets/bitcoin.avif" alt="AUVeggry Bitcoin"><p>Bitcoin</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>AUVeggry<i class="ic i-at"><em>@</em></i>sakura"s blog"</li><li class="link"><strong>Post link: </strong><a href="https://sakurame.eu.org/2024/03/16/vcbstudio/%E7%AC%AC%E5%85%AB%E7%AB%A0VS%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80/" title="第八章VS视频处理基础">https://sakurame.eu.org/2024/03/16/vcbstudio/第八章VS视频处理基础/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%83%E7%AB%A0%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%E5%99%A8%E5%9F%BA%E7%A1%80/" rel="prev" itemprop="url" data-background-image="https://ptpimg.me/e1davo.jpg" title="第七章视频编码器基础"><span class="type">Previous Post</span><span class="category"><i class="ic i-flag"></i>视频压制技术</span><h3>第七章视频编码器基础</h3></a></div><div class="item right"><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B9%9D%E7%AB%A0%E5%88%9D%E7%BA%A7%E8%A7%86%E9%A2%91%E7%91%95%E7%96%B5%E4%BF%AE%E5%A4%8D/" rel="next" itemprop="url" data-background-image="https://ptpimg.me/4501me.jpg" title="第九章初级视频瑕疵修复"><span class="type">Next Post</span><span class="category"><i class="ic i-flag"></i>视频压制技术</span><h3>第九章初级视频瑕疵修复</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-vs%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text"> 第八章 VS视频处理基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-resizer%E5%BA%94%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text"> 1. Resizer应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B9%B3%E7%A7%BB%E5%92%8C%E8%A3%81%E5%89%AAshift-crop"><span class="toc-number">1.1.1.</span> <span class="toc-text"> (1). 平移和裁剪（shift &amp; crop）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%BA%E5%AF%B8%E5%8F%98%E6%8D%A2resize"><span class="toc-number">1.1.2.</span> <span class="toc-text"> (2). 尺寸变换（resize）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-fmtconv%E7%9A%84%E9%80%90%E5%B9%B3%E9%9D%A2%E5%A4%84%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text"> (3). fmtconv的逐平面处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-matrix%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.1.4.</span> <span class="toc-text"> (4). Matrix转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-transfer%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.1.5.</span> <span class="toc-text"> (5). Transfer转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-gamma-awara-resize"><span class="toc-number">1.1.6.</span> <span class="toc-text"> (6). Gamma awara-resize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-chroma-subsample-%E4%B8%8E-chroma-placement"><span class="toc-number">1.1.7.</span> <span class="toc-text"> (7). Chroma subsample 与 Chroma placement</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-blurring"><span class="toc-number">1.2.</span> <span class="toc-text"> 2. Blurring</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-removegrain"><span class="toc-number">1.2.1.</span> <span class="toc-text"> (1). RemoveGrain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%80%BC%E6%A8%A1%E7%B3%8Aaverage-blur"><span class="toc-number">1.2.1.1.</span> <span class="toc-text"> 平均值模糊（Average Blur）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E4%BD%8D%E6%95%B0%E6%A8%A1%E7%B3%8Amedian-blur"><span class="toc-number">1.2.1.2.</span> <span class="toc-text"> 中位数模糊（Median Blur）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E5%80%BC%E6%A8%A1%E7%B3%8A-vs-%E4%B8%AD%E4%BD%8D%E6%95%B0%E6%A8%A1%E7%B3%8A"><span class="toc-number">1.2.1.3.</span> <span class="toc-text"> 中值模糊 vs 中位数模糊</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B9%B3%E5%9D%87%E6%9D%83%E9%87%8D"><span class="toc-number">1.2.1.4.</span> <span class="toc-text"> 自定义平均权重</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-usmunsharp-mask"><span class="toc-number">1.2.2.</span> <span class="toc-text"> (2). USM（Unsharp Mask）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clip%E7%9A%84%E7%AE%80%E5%8D%95%E8%BF%90%E7%AE%97"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> clip的简单运算</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#vscorestdmergeclipa-clipb-weight"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text"> vs.core.std.Merge(clipa, clipb, weight)：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#vscorestdmakediffclipa-clipb"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text"> vs.core.std.MakeDiff(clipa, clipb)以及vs.core.std.Mergediff(clipa, clipb)：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E5%99%AA%E7%82%B9%E5%B1%82"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 分离噪点层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unsharp-mask"><span class="toc-number">1.2.2.3.</span> <span class="toc-text"> Unsharp Mask</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-sbr"><span class="toc-number">1.2.3.</span> <span class="toc-text"> (3). SBR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-repair"><span class="toc-number">1.3.</span> <span class="toc-text"> 3. Repair</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-deringing"><span class="toc-number">1.3.1.</span> <span class="toc-text"> (1). Deringing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-non-ringing-upscale"><span class="toc-number">1.3.2.</span> <span class="toc-text"> (2). Non-ringing upscale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-rg-dering"><span class="toc-number">1.3.3.</span> <span class="toc-text"> (3). RG Dering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8repair-%E9%99%90%E5%88%B6usm"><span class="toc-number">1.3.4.</span> <span class="toc-text"> (4). 利用Repair 限制USM：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-contra-sharpen"><span class="toc-number">1.3.5.</span> <span class="toc-text"> (5). Contra-Sharpen</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-limitfilter"><span class="toc-number">1.4.</span> <span class="toc-text"> 4. LimitFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-limitfilter-%E4%B8%8E-usm"><span class="toc-number">1.4.1.</span> <span class="toc-text"> (1). LimitFilter 与 USM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-limitfilter-%E4%B8%8E-deband"><span class="toc-number">1.4.2.</span> <span class="toc-text"> (2). LimitFilter 与 Deband</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-limitfilter-%E8%9E%8D%E5%90%88%E7%BA%BF%E6%9D%A1%E4%B8%8E%E9%9D%9E%E7%BA%BF%E6%9D%A1"><span class="toc-number">1.4.3.</span> <span class="toc-text"> (3). LimitFilter 融合线条与非线条</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2023/05/17/vcbstudio/%E5%BC%80%E6%BA%90%E4%B8%80%E4%B8%8B%E5%BD%93%E5%88%9D%E5%8E%8B%E5%88%B6%E7%BB%84%E5%85%A5%E7%BB%84%E8%80%83%E8%AF%95%E7%9A%84%E7%AD%94%E5%8D%B7/" rel="bookmark" title="开源一下当初压制组入组考试的答卷">开源一下当初压制组入组考试的答卷</a></li><li><a href="/2023/05/18/vcbstudio/%E5%BC%80%E6%BA%90%E4%B8%80%E4%B8%8B%E5%8E%8B%E5%88%B6%E7%BB%84%E8%80%83%E8%AF%95%E7%9A%84%E8%AF%95%E9%A2%98/" rel="bookmark" title="开源一下压制组考试的试题">开源一下压制组考试的试题</a></li><li><a href="/2023/06/09/vcbstudio/%E7%86%9F%E6%82%89VapourSynth/" rel="bookmark" title="熟悉VapourSynth">熟悉VapourSynth</a></li><li><a href="/2023/06/11/vcbstudio/%E7%A5%9E%E4%B8%80%E6%A0%B7%E7%9A%84%E5%B7%A5%E5%85%B7%E4%BB%AC/" rel="bookmark" title="神一样的工具们">神一样的工具们</a></li><li><a href="/2023/06/11/vcbstudio/%E8%AE%A4%E8%AF%86%E7%91%95%E7%96%B5/" rel="bookmark" title="认识瑕疵">认识瑕疵</a></li><li><a href="/2023/06/11/vcbstudio/VapourSynth%E5%9F%BA%E7%A1%80/" rel="bookmark" title="VapourSynth基础">VapourSynth基础</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E8%AE%A4%E8%AF%86%E8%A7%86%E9%A2%91/" rel="bookmark" title="第一章从零开始认识视频">第一章从零开始认识视频</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E4%B8%80%E5%88%87%E7%9A%84%E8%B5%B7%E7%82%B9%E2%80%94%E2%80%94%E8%AE%A4%E8%AF%86BD/" rel="bookmark" title="第二章一切的起点——认识BD">第二章一切的起点——认识BD</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%89%E7%AB%A0%E7%A5%9E%E4%B8%80%E6%A0%B7%E7%9A%84%E5%B7%A5%E5%85%B7%E4%BB%AC/" rel="bookmark" title="第三章神一样的工具们">第三章神一样的工具们</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%9B%9B%E7%AB%A0%E8%AE%A4%E8%AF%86%E7%91%95%E7%96%B5/" rel="bookmark" title="第四章认识瑕疵">第四章认识瑕疵</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%BA%94%E7%AB%A0VapourSynth%E5%9F%BA%E7%A1%80/" rel="bookmark" title="第五章VapourSynth基础">第五章VapourSynth基础</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%85%AD%E7%AB%A0VS%E5%9F%BA%E7%A1%80%E6%BB%A4%E9%95%9C/" rel="bookmark" title="第六章VS基础滤镜">第六章VS基础滤镜</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%83%E7%AB%A0%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%E5%99%A8%E5%9F%BA%E7%A1%80/" rel="bookmark" title="第七章视频编码器基础">第七章视频编码器基础</a></li><li class="active"><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%85%AB%E7%AB%A0VS%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80/" rel="bookmark" title="第八章VS视频处理基础">第八章VS视频处理基础</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B9%9D%E7%AB%A0%E5%88%9D%E7%BA%A7%E8%A7%86%E9%A2%91%E7%91%95%E7%96%B5%E4%BF%AE%E5%A4%8D/" rel="bookmark" title="第九章初级视频瑕疵修复">第九章初级视频瑕疵修复</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%8D%81%E7%AB%A0%E5%88%9D%E7%AD%8930fps%E5%A4%84%E7%90%86/" rel="bookmark" title="第十章初等30fps处理">第十章初等30fps处理</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0OKEGui%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="bookmark" title="第十一章OKEGui的使用">第十一章OKEGui的使用</a></li><li><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A08-bit%E4%BD%8E%E7%A0%81%E7%8E%87%E5%8E%8B%E5%88%B6/" rel="bookmark" title="第十二章8-bit低码率压制">第十二章8-bit低码率压制</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="AUVeggry" src="/assets/avatar.avif"><p class="name" itemprop="name">AUVeggry</p><div class="description" itemprop="description">The spirit of independence and the freedom of thought </div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">65</span><span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span><span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">22</span><span class="name">tags</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/auveggry" class="item github" title="https://github.com/auveggry"><i class="ic i-github"></i></a><a href="mailto:mail@sakurame.eu.org" class="item email" title="mailto:mail@sakurame.eu.org"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-user"></i>About</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>About This Site</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>Appreciation</a></li><li class="item"><a href="/privacy/" rel="section"><i class="ic i-user"></i>Privacy Policy</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-sakura"></i>Friends</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B9%9D%E7%AB%A0%E5%88%9D%E7%BA%A7%E8%A7%86%E9%A2%91%E7%91%95%E7%96%B5%E4%BF%AE%E5%A4%8D/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%83%E7%AB%A0%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%E5%99%A8%E5%9F%BA%E7%A1%80/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div><div id="player"></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/game-engine/" title="In游戏引擎实践">游戏引擎实践</a></div><span><a href="/2023/06/26/game-engine/games104%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/">games104系列笔记（九）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/game-engine/" title="In游戏引擎实践">游戏引擎实践</a></div><span><a href="/2023/06/28/game-engine/games104%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89/">games104系列笔记（十一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/game-engine/" title="In游戏引擎实践">游戏引擎实践</a></div><span><a href="/2023/06/28/game-engine/games104%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89/">games104系列笔记（十七）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/basic-theory/" title="In计算机基础理论">计算机基础理论</a></div><span><a href="/2023/07/09/basic-theory/%E9%9B%85%E6%80%9D%E5%A4%87%E8%80%83%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86%E5%BD%92%E7%BA%B3%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0%E7%89%88/">雅思备考笔记整理归纳长期更新版</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/game-engine/" title="In游戏引擎实践">游戏引擎实践</a></div><span><a href="/2023/06/28/game-engine/games104%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89/">games104系列笔记（十六）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/vcbstudio/" title="In视频压制技术">视频压制技术</a></div><span><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B9%9D%E7%AB%A0%E5%88%9D%E7%BA%A7%E8%A7%86%E9%A2%91%E7%91%95%E7%96%B5%E4%BF%AE%E5%A4%8D/">第九章初级视频瑕疵修复</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/game-engine/" title="In游戏引擎实践">游戏引擎实践</a></div><span><a href="/2023/06/26/game-engine/games104%E7%B3%BB%E5%88%97%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%EF%BC%89/">games104系列笔记（十）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/vcbstudio/" title="In视频压制技术">视频压制技术</a></div><span><a href="/2024/03/16/vcbstudio/%E7%AC%AC%E4%B8%89%E7%AB%A0%E7%A5%9E%E4%B8%80%E6%A0%B7%E7%9A%84%E5%B7%A5%E5%85%B7%E4%BB%AC/">第三章神一样的工具们</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-graphic/" title="In计算机图形学">计算机图形学</a></div><span><a href="/2023/05/13/computer-graphic/3D-Graphics-Rendering-Cookbook/">3D-Graphics-Rendering-Cookbook</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/privacy/" title="In隐私保护指北">隐私保护指北</a></div><span><a href="/2023/04/24/privacy/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84UEFI%E4%BF%A1%E4%BB%BB%E9%93%BE/">从零开始构建自己的UEFI信任链</a></span></li></ul></div><div class="rpost pjax"><h2>Recent Comments</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">© 2023 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">AUVeggry @ Sakura's Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="Symbols count total">1.2m words</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="Reading time total">17:47</span></div><div class="powered-by">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div><br><span style="display:inline;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:var(--grey-5);"><a target="_blank" rel="noopener" href="https://icp.gov.moe/?keyword=20233555">萌ICP备20233555号</a></span></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
    path: `2024/03/16/vcbstudio/第八章VS视频处理基础/`,
    favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    nocopy: "false",
    copyright: `Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.`,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    }
};
</script><script src="/js/siteInit.js?v=0.5.4" type="module" fetchpriority="high" defer=""></script></body></html>